---
title: 代码运行
description: FastGPT 代码运行节点介绍
---

## 功能

代码运行节点支持在安全沙盒中执行 JavaScript 和 Python 代码，用于数据处理、格式转换、逻辑计算等场景。

**支持的语言**

- JavaScript（基于 Bun 运行时）
- Python 3

**注意事项**

- 私有化用户需要部署 `fastgpt-sandbox` 镜像，并配置 `SANDBOX_URL` 环境变量。
- 沙盒默认最大运行 10s，可通过配置调整。
- 代码运行在隔离的进程池中，无法访问文件系统和内网。

## 变量输入

可在自定义输入中添加代码运行需要的变量。

**JavaScript** — 在 main 函数参数中解构：

```js
async function main({data1, data2}){
    return {
        result: data1 + data2
    }
}
```

**Python** — 通过 `variables` 字典或函数参数获取：

```python
# 方式 1：无参数，通过全局 variables 访问
def main():
    return {"result": variables["data1"] + variables["data2"]}

# 方式 2：单参数，接收 variables 字典
def main(v):
    return {"result": v["data1"] + v["data2"]}

# 方式 3：多参数，按变量名匹配
def main(data1, data2):
    return {"result": data1 + data2}
```

## 结果输出

务必返回一个 object 对象（JS）或 dict 字典（Python）。

自定义输出中，可以添加变量名来获取对应 key 下的值。例如返回了：

```json
{
  "result": "hello",
  "count": 42
}
```

自定义输出中添加 `result` 和 `count` 两个变量即可获取对应的值。

## 内置全局函数

以下函数在 JS 和 Python 中均可使用：

### delay 延迟

延迟指定毫秒后继续执行，最大 10000ms。

```js
// JavaScript
async function main(){
    await delay(1000) // 延迟 1 秒
    return { result: "done" }
}
```

```python
# Python
def main():
    delay(1000)  # 延迟 1 秒
    return {"result": "done"}
```

### countToken 统计 token

估算文本的 token 数量（按字符数 / 4 计算）。

```js
// JavaScript
function main({input}){
    return { tokens: countToken(input) }
}
```

```python
# Python
def main():
    return {"tokens": count_token(variables["input"])}
```

### strToBase64 字符串转 base64

将字符串编码为 base64，可选添加前缀。适用于将 SVG 等内容转为 data URI。

```js
// JavaScript
function main({svg}){
    return {
        // 参数 1: 要转换的字符串
        // 参数 2: base64 前缀（可选）
        image: strToBase64(svg, 'data:image/svg+xml;base64,')
    }
}
```

```python
# Python
def main():
    return {
        "image": str_to_base64(variables["svg"], "data:image/svg+xml;base64,")
    }
```

### createHmac 签名

生成 HMAC 签名，返回 `{timestamp, sign}`。常用于对接钉钉、飞书等 Webhook。

```js
// JavaScript
function main({secret}){
    const {sign, timestamp} = createHmac('sha256', secret)
    return { sign, timestamp }
}
```

```python
# Python
def main():
    result = create_hmac("sha256", variables["secret"])
    return {"sign": result["sign"], "timestamp": result["timestamp"]}
```

### httpRequest 发起 HTTP 请求

在沙盒内发起外部 HTTP 请求。自动拦截内网地址（SSRF 防护）。

```js
// JavaScript
async function main({url}){
    const res = await httpRequest(url, {
        method: 'GET',       // 请求方法，默认 GET
        headers: {},         // 自定义请求头
        body: null,          // 请求体（对象会自动 JSON 序列化）
        timeout: 10          // 超时秒数，最大 10s
    })
    return {
        status: res.status,
        data: res.data
    }
}
```

```python
# Python
def main():
    res = http_request(variables["url"], method="GET", headers={}, timeout=10)
    return {"status": res["status"], "data": res["data"]}
```

**限制：**
- 每次执行最多 30 个请求
- 单次请求超时 10s
- 响应体最大 2MB
- 仅允许 http/https 协议
- 自动拦截内网 IP（127.0.0.0/8, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 等）

## 可用模块

### JavaScript 白名单模块

以下 npm 模块可通过 `require()` 使用：

| 模块 | 说明 | 示例 |
|------|------|------|
| `lodash` | 工具函数库 | `const _ = require('lodash')` |
| `moment` | 日期处理 | `const moment = require('moment')` |
| `dayjs` | 轻量日期库 | `const dayjs = require('dayjs')` |
| `crypto-js` | 加密库 | `const CryptoJS = require('crypto-js')` |
| `uuid` | UUID 生成 | `const { v4 } = require('uuid')` |
| `qs` | 查询字符串解析 | `const qs = require('qs')` |

其他模块（如 `fs`, `child_process`, `net` 等）被禁止使用。

### Python 安全模块

以下 Python 标准库模块可直接 import：

| 模块 | 说明 |
|------|------|
| `json` | JSON 解析 |
| `math` | 数学函数 |
| `re` | 正则表达式 |
| `datetime` | 日期时间 |
| `hashlib` | 哈希计算 |
| `base64` | Base64 编解码 |
| `collections` | 数据结构 |
| `time` | 时间函数 |

危险模块（如 `os`, `subprocess`, `sys`, `socket` 等）被禁止使用。

## 安全限制

沙盒提供多层安全防护：

- **模块拦截**：JS 和 Python 均只允许使用白名单模块
- **网络隔离**：自动拦截内网 IP 请求（SSRF 防护）
- **文件隔离**：无法读写容器文件系统
- **超时保护**：默认 10s 超时，防止死循环
- **进程隔离**：每次执行在独立的沙盒进程中运行

## 使用示例

### 数据格式转换

```js
// 将逗号分隔的字符串转为数组
function main({input}){
    const items = input.split(',').map(s => s.trim()).filter(Boolean)
    return { items, count: items.length }
}
```

### 日期计算

```js
const dayjs = require('dayjs')

function main(){
    const now = dayjs()
    return {
        today: now.format('YYYY-MM-DD'),
        nextWeek: now.add(7, 'day').format('YYYY-MM-DD'),
        timestamp: now.valueOf()
    }
}
```

### Python 数据处理

```python
import json
import math

def main(data):
    # 计算列表的统计信息
    numbers = data.get("numbers", [])
    if not numbers:
        return {"error": "no data"}
    
    return {
        "mean": sum(numbers) / len(numbers),
        "max": max(numbers),
        "min": min(numbers),
        "std": math.sqrt(sum((x - sum(numbers)/len(numbers))**2 for x in numbers) / len(numbers))
    }
```

### 飞书 Webhook 签名

```js
async function main({secret, url, message}){
    const {sign, timestamp} = createHmac('sha256', secret)
    
    const res = await httpRequest(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: {
            timestamp,
            sign,
            msg_type: 'text',
            content: { text: message }
        }
    })
    
    return { success: res.status === 200 }
}
```

## JS 与 Python 函数名对照

| 功能 | JavaScript | Python |
|------|-----------|--------|
| 统计 token | `countToken(text)` | `count_token(text)` |
| 字符串转 base64 | `strToBase64(text, prefix?)` | `str_to_base64(text, prefix?)` |
| HMAC 签名 | `createHmac(algo, secret)` | `create_hmac(algo, secret)` |
| 延迟 | `await delay(ms)` | `delay(ms)` |
| HTTP 请求 | `await httpRequest(url, opts?)` | `http_request(url, method?, headers?, body?, timeout?)` |

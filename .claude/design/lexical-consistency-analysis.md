# Lexical Editor æ–‡æœ¬è§£æä¸€è‡´æ€§åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

é€šè¿‡å¯¹ `textToEditorState` å’Œ `editorStateToText` å‡½æ•°çš„å…¨é¢åˆ†æ,å‘ç°äº† **3 ä¸ªç¡®è®¤çš„ä¸ä¸€è‡´æ€§é—®é¢˜**,ä¼šå¯¼è‡´ç”¨æˆ·ä¿å­˜åé‡æ–°åŠ è½½æ—¶çœ‹åˆ°ä¸ç¼–è¾‘å™¨æ˜¾ç¤ºä¸åŒçš„å†…å®¹ã€‚

### ä¸¥é‡é—®é¢˜æ€»è§ˆ

| é—®é¢˜ | ä¸¥é‡æ€§ | å½±å“ | ä½ç½® |
|------|--------|------|------|
| åˆ—è¡¨é¡¹å°¾éƒ¨ç©ºæ ¼ä¸¢å¤± | ğŸ”´ é«˜ | ç”¨æˆ·æœ‰æ„æ·»åŠ çš„ç©ºæ ¼è¢«åˆ é™¤ | utils.ts:255 |
| æœ‰åºåˆ—è¡¨åºå·é‡ç½® | ğŸ”´ é«˜ | è‡ªå®šä¹‰åºå·å˜æˆè¿ç»­åºå· | utils.ts:257 |
| åˆ—è¡¨é¡¹å†…æ¢è¡Œä¸å¯¹ç§° | ğŸŸ¡ ä¸­ | ç¼–è¾‘å™¨æ”¯æŒä½†æ— æ³•å¾€è¿” | processListItem |

---

## é—®é¢˜ 1: åˆ—è¡¨é¡¹å°¾éƒ¨ç©ºæ ¼ä¸¢å¤± ğŸ”´(å·²å¤„ç†)

### é—®é¢˜æè¿°

åœ¨ `processListItem` å‡½æ•°ä¸­ä½¿ç”¨äº† `trim()` å¤„ç†åˆ—è¡¨é¡¹æ–‡æœ¬:

```typescript
// utils.ts:255
const itemTextString = itemText.join('').trim();
```

### ä¸ä¸€è‡´æ€§æ¼”ç¤º

**ç”¨æˆ·è¾“å…¥:**
```
- hello world
```
(æ³¨æ„ "world" åé¢æœ‰ 2 ä¸ªç©ºæ ¼)

**EditorState:**
```json
{
  "type": "listitem",
  "children": [
    { "type": "text", "text": "hello world  " }
  ]
}
```

**è¾“å‡ºæ–‡æœ¬:**
```
- hello world
```
(å°¾éƒ¨ç©ºæ ¼è¢« trim åˆ é™¤)

**é‡æ–°åŠ è½½:**
```
- hello world
```
(ç”¨æˆ·çš„ç©ºæ ¼æ°¸ä¹…ä¸¢å¤±)

### å½±å“åˆ†æ

- **ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·æœ‰æ„æ·»åŠ çš„å°¾éƒ¨ç©ºæ ¼(å¯èƒ½ç”¨äºæ ¼å¼å¯¹é½)ä¼šä¸¢å¤±
- **æ•°æ®å®Œæ•´æ€§**: æ¯æ¬¡ä¿å­˜/åŠ è½½å¾ªç¯éƒ½ä¼šä¸¢å¤±å°¾éƒ¨ç©ºæ ¼
- **ä¸¥é‡ç¨‹åº¦**: é«˜ - ç›´æ¥å½±å“ç”¨æˆ·è¾“å…¥çš„å®Œæ•´æ€§

### è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: ç§»é™¤ trim()**
```typescript
const itemTextString = itemText.join(''); // ä¸ä½¿ç”¨ trim
```

**æ–¹æ¡ˆ 2: åªç§»é™¤å‰å¯¼ç©ºæ ¼**
```typescript
const itemTextString = itemText.join('').trimStart(); // åªç§»é™¤å¼€å¤´ç©ºæ ¼
```

**æ¨è**: æ–¹æ¡ˆ 1,å®Œå…¨ä¿ç•™ç”¨æˆ·è¾“å…¥çš„ç©ºæ ¼

---

## é—®é¢˜ 2: æœ‰åºåˆ—è¡¨åºå·é‡ç½® ğŸ”´

### é—®é¢˜æè¿°

åœ¨è¾“å‡ºæœ‰åºåˆ—è¡¨æ—¶,ä½¿ç”¨ `index + 1` è€Œä¸æ˜¯åˆ—è¡¨é¡¹è‡ªèº«çš„ `value`:

```typescript
// utils.ts:257
const prefix = listType === 'bullet' ? '- ' : `${index + 1}. `;
```

ä½†åœ¨è§£ææ—¶,`numberValue` è¢«æ­£ç¡®æå–å¹¶å­˜å‚¨åˆ° `listItem.value`ã€‚

### ä¸ä¸€è‡´æ€§æ¼”ç¤º

**ç”¨æˆ·è¾“å…¥:**
```
1. first
2. second
5. fifth
10. tenth
```

**è§£æ (textToEditorState):**
```javascript
items = [
  { numberValue: 1, text: "first" },
  { numberValue: 2, text: "second" },
  { numberValue: 5, text: "fifth" },
  { numberValue: 10, text: "tenth" }
]
```

**EditorState:**
```json
[
  { "value": 1, "text": "first" },
  { "value": 2, "text": "second" },
  { "value": 5, "text": "fifth" },
  { "value": 10, "text": "tenth" }
]
```

**è¾“å‡ºæ–‡æœ¬ (editorStateToText):**
```
1. first    (index=0, 0+1=1) âœ“
2. second   (index=1, 1+1=2) âœ“
3. fifth    (index=2, 2+1=3) âœ— åº”è¯¥æ˜¯ 5
4. tenth    (index=3, 3+1=4) âœ— åº”è¯¥æ˜¯ 10
```

**é‡æ–°åŠ è½½:**
ç”¨æˆ·çš„è‡ªå®šä¹‰åºå· 5 å’Œ 10 æ°¸ä¹…ä¸¢å¤±,å˜æˆè¿ç»­çš„ 3 å’Œ 4ã€‚

### å½±å“åˆ†æ

- **ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·æœ‰æ„è®¾ç½®çš„åºå·è¢«å¼ºåˆ¶æ”¹ä¸ºè¿ç»­åºå·
- **æ•°æ®å®Œæ•´æ€§**: æœ‰åºåˆ—è¡¨çš„è¯­ä¹‰ä¸¢å¤±(å¦‚ç« èŠ‚ç¼–å· 1.1, 1.2, 2.1)
- **ä¸¥é‡ç¨‹åº¦**: é«˜ - æ”¹å˜äº†ç”¨æˆ·çš„è¯­ä¹‰è¡¨è¾¾

### è§£å†³æ–¹æ¡ˆ

```typescript
// utils.ts:257
const prefix = listType === 'bullet'
  ? '- '
  : `${listItem.value || index + 1}. `;
```

ä½¿ç”¨ `listItem.value` è€Œä¸æ˜¯ `index + 1`,ä¿ç•™åŸå§‹åºå·ã€‚

---

## é—®é¢˜ 3: åˆ—è¡¨é¡¹å†…æ¢è¡Œä¸å¯¹ç§° ğŸŸ¡

### é—®é¢˜æè¿°

Lexical ç¼–è¾‘å™¨å…è®¸åœ¨åˆ—è¡¨é¡¹å†…æ’å…¥æ¢è¡Œç¬¦ (`linebreak` èŠ‚ç‚¹),ä½† `textToEditorState` æ— æ³•å°†åŒ…å«æ¢è¡Œçš„æ–‡æœ¬é‡æ–°è§£æä¸ºåˆ—è¡¨é¡¹å†…æ¢è¡Œã€‚

### ä¸ä¸€è‡´æ€§æ¼”ç¤º

**ç”¨æˆ·åœ¨ç¼–è¾‘å™¨ä¸­æ“ä½œ:**
```
1. è¾“å…¥: "- item1"
2. æŒ‰ Shift+Enter (æ’å…¥è½¯æ¢è¡Œ)
3. ç»§ç»­è¾“å…¥: "continued content"
```

**EditorState:**
```json
{
  "type": "listitem",
  "children": [
    { "type": "text", "text": "item1" },
    { "type": "linebreak" },
    { "type": "text", "text": "continued content" }
  ]
}
```

**è¾“å‡ºæ–‡æœ¬ (editorStateToText):**
```
- item1
continued content
```

**é‡æ–°åŠ è½½ (textToEditorState):**
```
è¡Œ1: "- item1" â†’ åˆ—è¡¨é¡¹
è¡Œ2: "continued content" â†’ æ®µè½ (ä¸å†æ˜¯åˆ—è¡¨é¡¹çš„ä¸€éƒ¨åˆ†!)
```

**æœ€ç»ˆç»“æ„å˜åŒ–:**
```
åŸæ¥: 1ä¸ªåˆ—è¡¨é¡¹(åŒ…å«æ¢è¡Œ)
ç°åœ¨: 1ä¸ªåˆ—è¡¨é¡¹ + 1ä¸ªæ®µè½
```

### å½±å“åˆ†æ

- **ç»“æ„å®Œæ•´æ€§**: åˆ—è¡¨é¡¹çš„å†…éƒ¨ç»“æ„åœ¨ä¿å­˜/åŠ è½½åæ”¹å˜
- **è¯­ä¹‰ä¸¢å¤±**: åŸæœ¬å±äºåˆ—è¡¨é¡¹çš„å†…å®¹å˜æˆäº†ç‹¬ç«‹æ®µè½
- **ä¸¥é‡ç¨‹åº¦**: ä¸­ - å½±å“æ–‡æ¡£ç»“æ„,ä½†å¯èƒ½ç¬¦åˆ Markdown è¯­ä¹‰

### è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1: åœ¨è¾“å‡ºæ—¶å°†æ¢è¡Œè½¬ä¸ºç©ºæ ¼**
```typescript
if (child.type === 'linebreak') {
  itemText.push(' '); // ä½¿ç”¨ç©ºæ ¼è€Œä¸æ˜¯ \n
}
```

**æ–¹æ¡ˆ 2: åœ¨ç¼–è¾‘å™¨ä¸­ç¦æ­¢åˆ—è¡¨é¡¹å†…æ¢è¡Œ**
- é…ç½® Lexical ä¸å…è®¸åœ¨åˆ—è¡¨é¡¹å†…æ’å…¥ linebreak
- ç”¨æˆ·åªèƒ½é€šè¿‡åˆ›å»ºæ–°åˆ—è¡¨é¡¹æ¥æ¢è¡Œ

**æ–¹æ¡ˆ 3: æ”¯æŒ Markdown é£æ ¼çš„åˆ—è¡¨é¡¹å¤šè¡Œ**
```typescript
// è¯†åˆ«ç¼©è¿›çš„è¡Œä¸ºåˆ—è¡¨é¡¹çš„ç»§ç»­å†…å®¹
parseTextLine:
if (line.startsWith('  ') && prevLine.wasListItem) {
  // ä½œä¸ºåˆ—è¡¨é¡¹çš„ç»§ç»­å†…å®¹
}
```

**æ¨è**: æ–¹æ¡ˆ 1 (æœ€ç®€å•) æˆ–æ–¹æ¡ˆ 2 (æœ€æ˜ç¡®)

---

## å…¶ä»–æ½œåœ¨é—®é¢˜

### é—®é¢˜ 4: å˜é‡èŠ‚ç‚¹ä¿å­˜åå˜æˆæ™®é€šæ–‡æœ¬ ğŸŸ¡

**ç°è±¡**:
```
EditorState: { type: 'variableLabel', variableKey: '{{var1}}' }
  â†“
è¾“å‡ºæ–‡æœ¬: "{{var1}}"
  â†“
é‡æ–°åŠ è½½: { type: 'text', text: "{{var1}}" }
```

**å½±å“**: å˜é‡èŠ‚ç‚¹çš„åŠŸèƒ½æ€§ä¸¢å¤±

**åˆ†æ**: è¿™å¯èƒ½æ˜¯è®¾è®¡å†³ç­– - å˜é‡åªåœ¨ç¼–è¾‘ä¼šè¯ä¸­æœ‰æ•ˆ,ä¿å­˜åˆ°æ–‡æœ¬åå˜æˆæ™®é€šå ä½ç¬¦ã€‚å¦‚æœéœ€è¦ä¿æŒå˜é‡åŠŸèƒ½,åº”è¯¥ä½¿ç”¨å…¶ä»–å­˜å‚¨æ ¼å¼(å¦‚ JSON)è€Œä¸æ˜¯çº¯æ–‡æœ¬ã€‚

### é—®é¢˜ 5: éè¿ç»­ç¼©è¿›çº§åˆ«å¯èƒ½å¯¼è‡´ç»“æ„é”™è¯¯ ğŸŸ¡

**ç°è±¡**:
```
è¾“å…¥:
- level 0
    - level 2 (è·³è¿‡ level 1)
  - level 1
```

**é—®é¢˜**: `buildListStructure` å¯èƒ½æ— æ³•æ­£ç¡®å¤„ç†éè¿ç»­çš„ç¼©è¿›çº§åˆ«

**å½±å“**: åˆ—è¡¨åµŒå¥—ç»“æ„å¯èƒ½ä¸ç¬¦åˆé¢„æœŸ

**å»ºè®®**: è§„èŒƒåŒ–ç¼©è¿›çº§åˆ«,æˆ–åœ¨æ–‡æ¡£ä¸­è¯´æ˜åªæ”¯æŒè¿ç»­ç¼©è¿›

---

## æ­£å¸¸è¿ä½œçš„éƒ¨åˆ† âœ…

ç»è¿‡åˆ†æ,ä»¥ä¸‹åŠŸèƒ½**æ­£å¸¸è¿ä½œ**,ä¸å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜:

1. **ç©ºè¡Œå¤„ç†** - ç©ºè¡Œè¢«æ­£ç¡®ä¿ç•™å’Œè¿˜åŸ
2. **æ®µè½å‰å¯¼ç©ºæ ¼** - ä¿®å¤åå®Œå…¨ä¿ç•™
3. **åˆ—è¡¨å’Œæ®µè½è¾¹ç•Œ** - æ­£ç¡®è¯†åˆ«å’Œåˆ†ç¦»
4. **ç‰¹æ®Šå­—ç¬¦åœ¨æ®µè½ä¸­** - åªæœ‰è¡Œé¦–çš„ `- ` å’Œ `\d+. ` è¢«è¯†åˆ«ä¸ºåˆ—è¡¨
5. **æ··åˆåˆ—è¡¨ç±»å‹** - bullet å’Œ number åˆ—è¡¨æ­£ç¡®åˆ†ç¦»
6. **åˆ—è¡¨ç¼©è¿›** - ä½¿ç”¨ TabStr ç»Ÿä¸€ä¸º 2 ä¸ªç©ºæ ¼

---

## æµ‹è¯•ç”¨ä¾‹å»ºè®®

### æµ‹è¯•ç”¨ä¾‹ 1: åˆ—è¡¨é¡¹å°¾éƒ¨ç©ºæ ¼
```typescript
const input = "- hello world  "; // 2ä¸ªå°¾éƒ¨ç©ºæ ¼
const state = textToEditorState(input, true);
const editor = createEditorWithState(state);
const output = editorStateToText(editor);
expect(output).toBe("- hello world  "); // åº”ä¿ç•™ç©ºæ ¼
```

### æµ‹è¯•ç”¨ä¾‹ 2: è‡ªå®šä¹‰åˆ—è¡¨åºå·
```typescript
const input = "1. first\n5. fifth\n10. tenth";
const state = textToEditorState(input, true);
const editor = createEditorWithState(state);
const output = editorStateToText(editor);
expect(output).toBe("1. first\n5. fifth\n10. tenth"); // åº”ä¿ç•™åºå·
```

### æµ‹è¯•ç”¨ä¾‹ 3: åˆ—è¡¨é¡¹æ¢è¡Œ
```typescript
// åœ¨ç¼–è¾‘å™¨ä¸­åˆ›å»ºåˆ—è¡¨é¡¹å¹¶æ’å…¥ linebreak
const editor = createEditor();
// ... åˆ›å»ºåˆ—è¡¨é¡¹
// ... æ’å…¥ linebreak
const output = editorStateToText(editor);
const reloadedState = textToEditorState(output, true);
const reloadedEditor = createEditorWithState(reloadedState);
// éªŒè¯ç»“æ„æ˜¯å¦ä¸€è‡´
expect(getStructure(editor)).toEqual(getStructure(reloadedEditor));
```

### æµ‹è¯•ç”¨ä¾‹ 4: å¾€è¿”å¯¹ç§°æ€§
```typescript
const testCases = [
  "simple text",
  "  indented text",
  "- bullet list\n  - nested",
  "1. first\n2. second\n5. fifth",
  "text\n\n\nwith\n\nempty\n\nlines",
  "- item  ", // å°¾éƒ¨ç©ºæ ¼
];

testCases.forEach(input => {
  const state = textToEditorState(input, true);
  const editor = createEditorWithState(state);
  const output = editorStateToText(editor);
  expect(output).toBe(input); // åº”å®Œå…¨ä¸€è‡´
});
```

---

## ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### P0 - ç«‹å³ä¿®å¤
1. âœ… **åˆ—è¡¨é¡¹å°¾éƒ¨ç©ºæ ¼ä¸¢å¤±** - å½±å“æ•°æ®å®Œæ•´æ€§
2. âœ… **æœ‰åºåˆ—è¡¨åºå·é‡ç½®** - å½±å“è¯­ä¹‰è¡¨è¾¾

### P1 - é«˜ä¼˜å…ˆçº§
3. âš ï¸ **åˆ—è¡¨é¡¹å†…æ¢è¡Œä¸å¯¹ç§°** - å½±å“ç»“æ„ä¸€è‡´æ€§

### P2 - æŒ‰éœ€ä¿®å¤
4. ğŸ“ **å˜é‡èŠ‚ç‚¹** - æ ¹æ®äº§å“éœ€æ±‚å†³å®š
5. ğŸ“ **éè¿ç»­ç¼©è¿›** - æ–‡æ¡£è¯´æ˜æˆ–è§„èŒƒåŒ–å¤„ç†

---

## ä»£ç ä¿®æ”¹å»ºè®®

### ä¿®æ”¹ 1: ä¿ç•™åˆ—è¡¨é¡¹ç©ºæ ¼
```diff
// utils.ts:255
- const itemTextString = itemText.join('').trim();
+ const itemTextString = itemText.join('');
```

### ä¿®æ”¹ 2: ä½¿ç”¨åŸå§‹åˆ—è¡¨åºå·
```diff
// utils.ts:257
- const prefix = listType === 'bullet' ? '- ' : `${index + 1}. `;
+ const prefix = listType === 'bullet' ? '- ' : `${listItem.value || index + 1}. `;
```

### ä¿®æ”¹ 3: å¤„ç†åˆ—è¡¨é¡¹æ¢è¡Œ(æ–¹æ¡ˆ1)
```diff
// utils.ts:242
  if (child.type === 'linebreak') {
-   itemText.push('\n');
+   itemText.push(' '); // è½¬ä¸ºç©ºæ ¼è€Œä¸æ˜¯æ¢è¡Œ
  }
```

---

## æ€»ç»“

é€šè¿‡å…¨é¢åˆ†æ,ç¡®è®¤äº† **3 ä¸ªä¼šå¯¼è‡´ç¼–è¾‘å™¨æ˜¾ç¤ºä¸è§£ææ–‡æœ¬ä¸ä¸€è‡´çš„é—®é¢˜**:

1. ğŸ”´ åˆ—è¡¨é¡¹å°¾éƒ¨ç©ºæ ¼ä¸¢å¤± â†’ ä¿®å¤: ç§»é™¤ trim()
2. ğŸ”´ æœ‰åºåˆ—è¡¨åºå·é‡ç½® â†’ ä¿®å¤: ä½¿ç”¨ listItem.value
3. ğŸŸ¡ åˆ—è¡¨é¡¹å†…æ¢è¡Œä¸å¯¹ç§° â†’ ä¿®å¤: è½¬æ¢ä¸ºç©ºæ ¼æˆ–ç¦æ­¢

å…¶ä»–æ–¹é¢(ç©ºè¡Œã€å‰å¯¼ç©ºæ ¼ã€è¾¹ç•Œå¤„ç†)éƒ½è¿ä½œæ­£å¸¸ã€‚

å»ºè®®ä¼˜å…ˆä¿®å¤å‰ä¸¤ä¸ª P0 é—®é¢˜,ç¡®ä¿ç”¨æˆ·æ•°æ®çš„å®Œæ•´æ€§å’Œè¯­ä¹‰å‡†ç¡®æ€§ã€‚

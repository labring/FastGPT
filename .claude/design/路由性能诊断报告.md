# FastGPT Next.js 14 Page Router è·¯ç”±æ€§èƒ½è¯Šæ–­æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šé’ˆå¯¹ FastGPT projects/app é¡¹ç›®çš„è·¯ç”±åˆ‡æ¢æ€§èƒ½é—®é¢˜è¿›è¡Œäº†ç³»ç»Ÿæ€§åˆ†æã€‚è¯¥é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº Next.js 14 Page Router çš„å¤§å‹ monorepo åº”ç”¨ï¼Œè·¯ç”±åˆ‡æ¢æ€§èƒ½é—®é¢˜åœ¨å¼€å‘ç¯å¢ƒä¸­å°¤ä¸ºä¸¥é‡ã€‚

**å…³é”®å‘ç°**ï¼š
- ğŸ”´ **ä¸¥é‡**: è¿‡åº¦çš„ getServerSideProps ä½¿ç”¨å¯¼è‡´æ¯æ¬¡è·¯ç”±åˆ‡æ¢éƒ½éœ€è¦å®Œæ•´çš„æœåŠ¡ç«¯æ•°æ®åŠ è½½
- ğŸ”´ **ä¸¥é‡**: 314ä¸ªé¡µé¢ç»„ä»¶ + 149ä¸ªé€šç”¨ç»„ä»¶çš„åºå¤§ä»£ç åº“ï¼Œç¼ºä¹æœ‰æ•ˆçš„ä»£ç åˆ†å‰²
- ğŸŸ¡ **é‡è¦**: å›½é™…åŒ–(i18n)åœ¨æœåŠ¡ç«¯åŒæ­¥åŠ è½½ï¼Œé˜»å¡é¡µé¢æ¸²æŸ“
- ğŸŸ¡ **é‡è¦**: Chakra UI ä¸»é¢˜ç³»ç»Ÿå¯¼è‡´å¤§é‡æ ·å¼è®¡ç®—å’Œé‡æ¸²æŸ“
- ğŸŸ¡ **é‡è¦**: å¼€å‘ç¯å¢ƒä¸‹ React Strict Mode è¢«ç¦ç”¨ï¼Œä½† HMR å’Œç¼–è¯‘æ€§èƒ½æœªä¼˜åŒ–

---

## 1. é¡¹ç›®æ¶æ„åˆ†æ

### 1.1 æŠ€æœ¯æ ˆæ¦‚è§ˆ

```yaml
æ¡†æ¶: Next.js 14.2.32 (Page Router)
React: 18.3.1
UI åº“: Chakra UI 2.10.7
çŠ¶æ€ç®¡ç†:
  - use-context-selector (Context API ä¼˜åŒ–)
  - @tanstack/react-query 4.24.10
  - Zustand (éƒ¨åˆ†çŠ¶æ€)
å›½é™…åŒ–: next-i18next 15.4.2
ç»„ä»¶è§„æ¨¡:
  - é¡µé¢ç»„ä»¶: 314 ä¸ªæ–‡ä»¶
  - é€šç”¨ç»„ä»¶: 149 ä¸ªæ–‡ä»¶
  - æ€»é¡µé¢è·¯ç”±: 32 ä¸ª
```

### 1.2 Monorepo ç»“æ„

```
FastGPT/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ global/        # å…±äº«ç±»å‹ã€å¸¸é‡
â”‚   â”œâ”€â”€ service/       # åç«¯æœåŠ¡ã€æ•°æ®åº“
â”‚   â”œâ”€â”€ web/          # å…±äº«å‰ç«¯ç»„ä»¶ã€hooks
â”‚   â””â”€â”€ templates/     # åº”ç”¨æ¨¡æ¿
â””â”€â”€ projects/
    â””â”€â”€ app/          # ä¸» Web åº”ç”¨ (åˆ†æå¯¹è±¡)
```

**å½±å“åˆ†æ**ï¼šworkspace ä¾èµ–é€šè¿‡ç¬¦å·é“¾æ¥ï¼Œå¼€å‘ç¯å¢ƒéœ€è¦ç›‘å¬å¤šä¸ªåŒ…çš„å˜åŒ–ï¼Œå¢åŠ äº† HMR å¤æ‚åº¦ã€‚

---

## 2. æ ¸å¿ƒæ€§èƒ½é—®é¢˜è¯Šæ–­

### 2.1 ğŸ”´ æœåŠ¡ç«¯æ•°æ®è·å–ç“¶é¢ˆ (P0 - æœ€é«˜ä¼˜å…ˆçº§)

#### é—®é¢˜æè¿°

**æ‰€æœ‰ 32 ä¸ªé¡µé¢è·¯ç”±éƒ½ä½¿ç”¨ getServerSideProps**ï¼Œå¯¼è‡´æ¯æ¬¡è·¯ç”±åˆ‡æ¢éƒ½éœ€è¦ï¼š

1. æœåŠ¡ç«¯æ¸²æŸ“ HTML
2. åŠ è½½å›½é™…åŒ–ç¿»è¯‘æ–‡ä»¶ï¼ˆé€šè¿‡ `serviceSideProps`ï¼‰
3. ç­‰å¾…æœåŠ¡ç«¯å“åº”åæ‰èƒ½å¼€å§‹å®¢æˆ·ç«¯æ°´åˆ

#### è¯æ®

```typescript
// projects/app/src/pages/app/detail/index.tsx:79
export async function getServerSideProps(context: any) {
  return {
    props: {
      ...(await serviceSideProps(context, ['app', 'chat', 'user', 'file', 'publish', 'workflow']))
    }
  };
}

// projects/app/src/pages/dataset/list/index.tsx:319
export async function getServerSideProps(content: any) {
  return {
    props: {
      ...(await serviceSideProps(content, ['dataset', 'user']))
    }
  };
}

// projects/app/src/pages/dashboard/agent/index.tsx:344
export async function getServerSideProps(content: any) {
  return {
    props: {
      ...(await serviceSideProps(content, ['app', 'user']))
    }
  };
}
```

#### æ€§èƒ½å½±å“

| é˜¶æ®µ | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ |
|------|---------|---------|
| æœåŠ¡ç«¯å¤„ç† | 200-500ms | 50-150ms |
| i18n åŠ è½½ | 100-300ms | 30-80ms |
| HTML ä¼ è¾“ | 50-100ms | 20-50ms |
| å®¢æˆ·ç«¯æ°´åˆ | 300-800ms | 100-300ms |
| **æ€»è®¡** | **650-1700ms** | **200-580ms** |

**å¼€å‘ç¯å¢ƒåŠ£åŠ¿**ï¼š
- æœªå‹ç¼©çš„ä»£ç 
- Source maps ç”Ÿæˆ
- å¼€å‘æœåŠ¡å™¨æ€§èƒ½é™åˆ¶
- çƒ­æ›´æ–°æ¨¡å—ç›‘å¬

### 2.2 ğŸ”´ å›½é™…åŒ–(i18n)åŠ è½½é˜»å¡ (P0)

#### é—®é¢˜æè¿°

`serviceSideProps` åœ¨æœåŠ¡ç«¯åŒæ­¥åŠ è½½æ‰€æœ‰éœ€è¦çš„å›½é™…åŒ–å‘½åç©ºé—´ï¼š

```typescript
// projects/app/src/web/common/i18n/utils.ts:4
export const serviceSideProps = async (content: any, ns: I18nNsType = []) => {
  const lang = content.req?.cookies?.NEXT_LOCALE || content.locale;
  const extraLng = content.req?.cookies?.NEXT_LOCALE ? undefined : content.locales;

  return {
    ...(await serverSideTranslations(lang, ['common', ...ns], undefined, extraLng)),
    deviceSize
  };
};
```

#### å‘½åç©ºé—´åŠ è½½ç¤ºä¾‹

```typescript
// app/detail é¡µé¢åŠ è½½ 6 ä¸ªå‘½åç©ºé—´
['common', 'app', 'chat', 'user', 'file', 'publish', 'workflow']

// æ¯ä¸ªå‘½åç©ºé—´çº¦ 10-50KB çš„ JSON
// æ€»è®¡: 60-300KB æœªå‹ç¼©çš„ç¿»è¯‘æ•°æ®
```

#### æ€§èƒ½å½±å“

- **é¦–æ¬¡åŠ è½½**: éœ€è¦è¯»å–å¹¶è§£æå¤šä¸ª JSON æ–‡ä»¶
- **æ¯æ¬¡è·¯ç”±åˆ‡æ¢**: é‡å¤åŠ è½½ç¿»è¯‘æ•°æ®ï¼ˆå³ä½¿å·²ç¼“å­˜ï¼‰
- **å¼€å‘ç¯å¢ƒ**: æ–‡ä»¶ç³»ç»Ÿè¯»å–æœªä¼˜åŒ–ï¼Œå»¶è¿Ÿæ›´é«˜

### 2.3 ğŸŸ¡ å®¢æˆ·ç«¯ä»£ç åˆ†å‰²ä¸è¶³ (P1)

#### é—®é¢˜æè¿°

è™½ç„¶ä½¿ç”¨äº† `dynamic()` è¿›è¡Œä»£ç åˆ†å‰²ï¼Œä½†ä»…åœ¨ 14 ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨ï¼Œè¦†ç›–ç‡ä¸è¶³ï¼š

```typescript
// projects/app/src/pages/app/detail/index.tsx:14-33
const SimpleEdit = dynamic(() => import('@/pageComponents/app/detail/SimpleApp'), {
  ssr: false,
  loading: () => <Loading fixed={false} />
});
const Workflow = dynamic(() => import('@/pageComponents/app/detail/Workflow'), {
  ssr: false,
  loading: () => <Loading fixed={false} />
});
const Plugin = dynamic(() => import('@/pageComponents/app/detail/Plugin'), {
  ssr: false,
  loading: () => <Loading fixed={false} />
});
```

#### é—®é¢˜æ‰€åœ¨

1. **Context Providers æœªåˆ†å‰²**ï¼šæ‰€æœ‰ Context åœ¨ `_app.tsx` ä¸­å…¨å±€åŠ è½½
2. **å¤§å‹ç»„ä»¶åº“**ï¼šChakra UI æ•´ä½“åŠ è½½ï¼ŒæœªæŒ‰éœ€å¯¼å…¥
3. **å…¬å…±ç»„ä»¶æ†ç»‘**ï¼š`packages/web/components` ä¸­çš„ 149 ä¸ªç»„ä»¶æ†ç»‘åœ¨ä¸» bundle

#### Bundle åˆ†æï¼ˆä¼°ç®—ï¼‰

```
ä¸» bundle:
- React + React DOM: ~130KB (gzipped)
- Chakra UI: ~80KB (gzipped)
- å…¬å…±ç»„ä»¶: ~150KB (gzipped)
- ä¸šåŠ¡é€»è¾‘: ~200KB (gzipped)
æ€»è®¡: ~560KB (gzipped)
```

### 2.4 ğŸŸ¡ Chakra UI æ€§èƒ½å¼€é”€ (P1)

#### é—®é¢˜æè¿°

Chakra UI çš„ä¸»é¢˜ç³»ç»Ÿå’Œæ ·å¼è®¡ç®—åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¼šäº§ç”Ÿå¼€é”€ï¼š

```typescript
// packages/web/styles/theme.ts åŒ…å«ï¼š
- 916 è¡Œå¤æ‚ä¸»é¢˜é…ç½®
- å¤šå±‚çº§æ ·å¼å˜ä½“ç³»ç»Ÿ
- è¿è¡Œæ—¶æ ·å¼è®¡ç®—
- å¤§é‡çš„ emotion styled-components
```

#### æ€§èƒ½å½±å“ç‚¹

1. **åˆå§‹åŒ–æˆæœ¬**ï¼šä¸»é¢˜å¯¹è±¡åˆ›å»ºå’Œå¤„ç†
2. **è¿è¡Œæ—¶æ ·å¼æ³¨å…¥**ï¼šemotion åŠ¨æ€ç”Ÿæˆ CSS
3. **é‡æ¸²æŸ“æˆæœ¬**ï¼štheme prop ä¼ é€’å¯¼è‡´æ·±å±‚ç»„ä»¶æ›´æ–°
4. **å¼€å‘ç¯å¢ƒ**: CSS-in-JS æœªä¼˜åŒ–ï¼Œæ¯æ¬¡æ›´æ”¹éƒ½é‡æ–°è®¡ç®—æ ·å¼

#### ä¸è·¯ç”±åˆ‡æ¢çš„å…³ç³»

```
è·¯ç”±åˆ‡æ¢
â†“
å¸è½½æ—§é¡µé¢ç»„ä»¶
â†“
æ¸…ç† emotion æ ·å¼
â†“
åŠ è½½æ–°é¡µé¢ç»„ä»¶
â†“
é‡æ–°æ³¨å…¥ Chakra UI æ ·å¼
â†“
è§¦å‘æ ·å¼é‡è®¡ç®—
= 100-200ms é¢å¤–å»¶è¿Ÿ
```

### 2.5 ğŸŸ¡ Context æ¶æ„å¯¼è‡´çš„é‡æ¸²æŸ“ (P1)

#### é—®é¢˜æè¿°

åº”ç”¨ä½¿ç”¨äº†å¤šå±‚åµŒå¥—çš„ Context Providersï¼š

```typescript
// projects/app/src/pages/_app.tsx:83-91
<QueryClientContext>
  <SystemStoreContextProvider device={pageProps.deviceSize}>
    <ChakraUIContext>
      {shouldUseLayout ? (
        <Layout>{setLayout(<Component {...pageProps} />)}</Layout>
      ) : (
        setLayout(<Component {...pageProps} />)
      )}
    </ChakraUIContext>
  </SystemStoreContextProvider>
</QueryClientContext>
```

åŠ ä¸Šé¡µé¢çº§ Contextï¼š

```typescript
// projects/app/src/pages/app/detail/index.tsx:72-76
<AppContextProvider>
  <AppDetail />
</AppContextProvider>

// projects/app/src/pageComponents/app/detail/context.tsx:93-100
const AppContextProvider = ({ children }: { children: ReactNode }) => {
  // å¤§é‡ hooks å’ŒçŠ¶æ€
  const router = useRouter();
  const { appId, currentTab } = router.query;
  // ... æ›´å¤šçŠ¶æ€å’Œå‰¯ä½œç”¨
}
```

#### æ€§èƒ½å½±å“

1. **Context å€¼å˜åŒ–**: è§¦å‘æ‰€æœ‰æ¶ˆè´¹è€…é‡æ¸²æŸ“
2. **åµŒå¥—æ·±åº¦**: 4-5 å±‚ Provider å¢åŠ åè°ƒæˆæœ¬
3. **è·¯ç”±åˆ‡æ¢æ—¶**: Context å®Œå…¨é”€æ¯å’Œé‡å»º
4. **use-context-selector**: è™½ç„¶æœ‰ä¼˜åŒ–ï¼Œä½†æ— æ³•è§£å†³è·¨è·¯ç”±çš„é‡å»ºæˆæœ¬

### 2.6 ğŸŸ¡ å¼€å‘ç¯å¢ƒç‰¹å®šé—®é¢˜ (P1)

#### next.config.js é…ç½®

```javascript
// projects/app/next.config.js:12
reactStrictMode: isDev ? false : true,
```

**åˆ†æ**ï¼š
- âœ… å¼€å‘ç¯å¢ƒç¦ç”¨ Strict Mode é¿å…åŒé‡æ¸²æŸ“
- âŒ ä½†ä»ç„¶å­˜åœ¨å…¶ä»–å¼€å‘ç¯å¢ƒå¼€é”€

#### å¼€å‘ç¯å¢ƒæ€§èƒ½ç“¶é¢ˆ

```yaml
HMR (çƒ­æ¨¡å—æ›¿æ¢):
  - ç›‘å¬ workspace ä¸­å¤šä¸ªåŒ…çš„å˜åŒ–
  - 314 ä¸ªé¡µé¢ç»„ä»¶çš„ä¾èµ–å›¾
  - Chakra UI ä¸»é¢˜çš„å®Œæ•´é‡æ–°è®¡ç®—

TypeScript ç¼–è¯‘:
  - å®æ—¶ç±»å‹æ£€æŸ¥
  - Source map ç”Ÿæˆ
  - è·¨ package ç±»å‹è§£æ

Webpack Dev Server:
  - æœªä¼˜åŒ–çš„ä»£ç ä¼ è¾“
  - å¼€å‘ä¸­é—´ä»¶å¤„ç†
  - Source map è§£æ
```

### 2.7 ğŸŸ¢ æ•°æ®è·å–ç­–ç•¥é—®é¢˜ (P2)

#### é—®é¢˜æè¿°

é¡µé¢ç»„ä»¶åœ¨å®¢æˆ·ç«¯è¿˜ä¼šå‘èµ·é¢å¤–çš„æ•°æ®è¯·æ±‚ï¼š

```typescript
// projects/app/src/pageComponents/app/detail/context.tsx:126-144
const { loading: loadingApp, runAsync: reloadApp } = useRequest2(
  () => {
    if (appId) {
      return getAppDetailById(appId);
    }
    return Promise.resolve(defaultApp);
  },
  {
    manual: false,
    refreshDeps: [appId],
    errorToast: t('common:core.app.error.Get app failed'),
    onError(err: any) {
      router.replace('/dashboard/agent');
    },
    onSuccess(res) {
      setAppDetail(res);
    }
  }
);
```

#### æ•°æ®æµåˆ†æ

```
ç”¨æˆ·ç‚¹å‡»è·¯ç”±
â†“
æœåŠ¡ç«¯: getServerSideProps è·å–åˆå§‹æ•°æ®
â†“
å®¢æˆ·ç«¯æ°´åˆ
â†“
Context Provider åˆå§‹åŒ–
â†“
useRequest2 å†æ¬¡è·å–æ•°æ® â† é‡å¤è¯·æ±‚!
â†“
é¡µé¢æ˜¾ç¤º
```

**é—®é¢˜**ï¼šå³ä½¿æœåŠ¡ç«¯å·²ç»è·å–äº†æ•°æ®ï¼Œå®¢æˆ·ç«¯ä»ç„¶ä¼šé‡æ–°è¯·æ±‚ï¼Œå¯¼è‡´ï¼š
- é‡å¤çš„ç½‘ç»œè¯·æ±‚
- é¢å¤–çš„åŠ è½½çŠ¶æ€
- æ•°æ®ä¸ä¸€è‡´é£é™©

### 2.8 ğŸŸ¢ å…¨å±€åˆå§‹åŒ–é’©å­ (P2)

```typescript
// projects/app/src/web/context/useInitApp.ts:132-136
useRequest2(initFetch, {
  refreshDeps: [userInfo?.username],
  manual: false,
  pollingInterval: 300000 // 5 åˆ†é’Ÿè½®è¯¢
});
```

**å½±å“**ï¼š
- æ¯ 5 åˆ†é’Ÿé‡æ–°è·å–é…ç½®
- åœ¨è·¯ç”±åˆ‡æ¢æ—¶å¯èƒ½è§¦å‘ä¸å¿…è¦çš„è¯·æ±‚
- å¼€å‘ç¯å¢ƒä¸‹å¢åŠ æœåŠ¡ç«¯è´Ÿè½½

---

## 3. æ€§èƒ½æŒ‡æ ‡ä¼°ç®—

### 3.1 è·¯ç”±åˆ‡æ¢æ—¶é—´çº¿ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```
äº‹ä»¶                        æ—¶é—´ (ms)      ç´¯è®¡ (ms)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·ç‚¹å‡»é“¾æ¥                    0             0
æµè§ˆå™¨å‘èµ·å¯¼èˆª                  10            10
Next.js æ‹¦æˆªè·¯ç”±               20            30
â†“
æœåŠ¡ç«¯å¤„ç†
â”œâ”€ getServerSideProps æ‰§è¡Œ     250           280
â”œâ”€ è¯»å– i18n æ–‡ä»¶              150           430
â”œâ”€ æœåŠ¡ç«¯æ¸²æŸ“ HTML             100           530
â””â”€ å“åº”è¿”å›                     50           580
â†“
å®¢æˆ·ç«¯å¤„ç†
â”œâ”€ è§£æ HTML                    30           610
â”œâ”€ åŠ è½½é¡µé¢ bundle             200           810
â”œâ”€ React æ°´åˆ                  150           960
â”œâ”€ Context åˆå§‹åŒ–               80          1040
â”œâ”€ Chakra UI æ ·å¼æ³¨å…¥          120          1160
â”œâ”€ å®¢æˆ·ç«¯æ•°æ®è·å–              300          1460
â””â”€ é¦–æ¬¡æ¸²æŸ“å®Œæˆ                100          1560
â†“
æ€»è®¡æ—¶é—´: 1560ms (1.5ç§’+)
```

### 3.2 ç”Ÿäº§ç¯å¢ƒå¯¹æ¯”

```
é˜¶æ®µ                    å¼€å‘ç¯å¢ƒ      ç”Ÿäº§ç¯å¢ƒ      æ”¹å–„
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æœåŠ¡ç«¯å¤„ç†              430ms         130ms        70%â†“
å®¢æˆ·ç«¯ bundle åŠ è½½      200ms          50ms        75%â†“
React æ°´åˆ              150ms          80ms        47%â†“
æ ·å¼æ³¨å…¥                120ms          40ms        67%â†“
æ•°æ®è·å–                300ms         300ms         0%
é¦–æ¬¡æ¸²æŸ“                100ms          50ms        50%â†“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡                   1300ms         650ms        50%â†“
```

**å…³é”®æ´å¯Ÿ**ï¼šå³ä½¿åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œ650ms çš„è·¯ç”±åˆ‡æ¢æ—¶é—´ä»ç„¶ä¸ç†æƒ³ï¼ˆç”¨æˆ·æ„ŸçŸ¥é˜ˆå€¼ä¸º 300msï¼‰ã€‚

---

## 4. æ ¹å› åˆ†æ

### 4.1 æ¶æ„å±‚é¢

```
é—®é¢˜: SSR + CSR åŒé‡æ•°æ®è·å–
æ ¹å› :
â”œâ”€ Page Router çš„ getServerSideProps æ¨¡å¼
â”œâ”€ å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†ä¸æœåŠ¡ç«¯æ•°æ®è„±èŠ‚
â””â”€ ç¼ºä¹ç»Ÿä¸€çš„æ•°æ®ç¼“å­˜ç­–ç•¥

é—®é¢˜: ç¼ºä¹å¢é‡åŠ è½½
æ ¹å› :
â”œâ”€ å…¨å±€ Context Providers ä¸€æ¬¡æ€§åŠ è½½
â”œâ”€ Chakra UI æ•´ä½“å¯¼å…¥
â””â”€ i18n ç¿»è¯‘æ–‡ä»¶å…¨é‡åŠ è½½
```

### 4.2 å®ç°å±‚é¢

```
é—®é¢˜: é‡æ¸²æŸ“å¼€é”€å¤§
æ ¹å› :
â”œâ”€ Context æ¶æ„å¯¼è‡´çº§è”æ›´æ–°
â”œâ”€ Chakra UI CSS-in-JS è¿è¡Œæ—¶å¼€é”€
â””â”€ å¤§å‹ç»„ä»¶æ ‘çš„åè°ƒæˆæœ¬

é—®é¢˜: å¼€å‘ç¯å¢ƒæ…¢
æ ¹å› :
â”œâ”€ Monorepo ç›‘å¬èŒƒå›´å¹¿
â”œâ”€ TypeScript è·¨åŒ…ç±»å‹æ£€æŸ¥
â””â”€ æœªä¼˜åŒ–çš„ webpack dev server
```

---

## 5. ä¼˜åŒ–å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰

### 5.1 ğŸ”´ P0: æ¶ˆé™¤æœåŠ¡ç«¯é˜»å¡ï¼ˆé¢„æœŸæ”¹å–„: 40-50%ï¼‰

#### æ–¹æ¡ˆ A: è¿ç§»åˆ° App Router (æ’é™¤è¯¥æ–¹æ¡ˆ)

**ä¼˜åŠ¿**ï¼š
- React Server Components åŸç”Ÿæ”¯æŒ
- è‡ªåŠ¨ä»£ç åˆ†å‰²å’Œæµå¼ SSR
- æ›´å¥½çš„æ•°æ®è·å–æ¨¡å¼ï¼ˆServer Actionsï¼‰
- å†…ç½®çš„éƒ¨åˆ†é¢„æ¸²æŸ“ï¼ˆPPRï¼‰

**å®æ–½æ­¥éª¤**ï¼š
```
1. åˆ›å»º app/ ç›®å½•å¹¶è¡Œè¿ç§»
2. å°†é™æ€é¡µé¢å…ˆè¿ç§»ï¼ˆå¦‚ /price, /moreï¼‰
3. é€æ­¥è¿ç§»åŠ¨æ€é¡µé¢
4. ä¿ç•™ pages/ ä½œä¸ºåå¤‡
5. å®Œå…¨è¿ç§»ååˆ é™¤ pages/
```

**å·¥ä½œé‡ä¼°ç®—**ï¼š4-6 å‘¨ï¼Œä¸­ç­‰é£é™©

#### æ–¹æ¡ˆ B: æ··åˆæ¸²æŸ“ç­–ç•¥ (å¿«é€Ÿæ”¹å–„)

å°†ä¸éœ€è¦ SEO çš„é¡µé¢æ”¹ä¸ºå®¢æˆ·ç«¯æ¸²æŸ“ï¼š

```typescript
// ä¸éœ€è¦ getServerSideProps çš„é¡µé¢
// projects/app/src/pages/app/detail/index.tsx

// åˆ é™¤ getServerSideProps
// export async function getServerSideProps() { ... }

// æ”¹ä¸ºå®¢æˆ·ç«¯æ•°æ®è·å–
function AppDetail() {
  const router = useRouter();
  const { appId } = router.query;

  const { data: appDetail, isLoading } = useRequest2(
    () => getAppDetailById(appId as string),
    {
      manual: false,
      refreshDeps: [appId],
      // ä½¿ç”¨ SWR ç¼“å­˜é¿å…é‡å¤è¯·æ±‚
      cacheKey: `app-detail-${appId}`,
      cacheTime: 5 * 60 * 1000 // 5 åˆ†é’Ÿç¼“å­˜
    }
  );

  if (isLoading) return <Loading />;
  return <AppDetailView detail={appDetail} />;
}
```

**é€‚ç”¨é¡µé¢**ï¼š
- `/app/detail` (åº”ç”¨ç¼–è¾‘é¡µ)
- `/dataset/detail` (æ•°æ®é›†è¯¦æƒ…é¡µ)
- `/dashboard/*` (ä»ªè¡¨æ¿é¡µé¢)
- `/account/*` (è´¦æˆ·è®¾ç½®é¡µé¢)

**ä¿ç•™ SSR çš„é¡µé¢**ï¼š
- `/chat/share` (SEO éœ€æ±‚)
- `/price` (è¥é”€é¡µé¢)
- ç™»å½•é¡µé¢ï¼ˆé¦–æ¬¡åŠ è½½ä½“éªŒï¼‰

**é¢„æœŸæ•ˆæœ**ï¼š
- è·¯ç”±åˆ‡æ¢æ—¶é—´å‡å°‘ 300-500ms
- æœåŠ¡ç«¯è´Ÿè½½é™ä½ 60%
- é¦–æ¬¡å†…å®¹ç»˜åˆ¶(FCP)å¯èƒ½å»¶è¿Ÿ 100-200msï¼ˆå¯æ¥å—ï¼‰

**å·¥ä½œé‡ä¼°ç®—**ï¼š1-2 å‘¨ï¼Œä½é£é™©

### 5.2 ğŸ”´ P0: ä¼˜åŒ–å›½é™…åŒ–åŠ è½½ï¼ˆé¢„æœŸæ”¹å–„: 20-30%ï¼‰

#### æ–¹æ¡ˆ: å®¢æˆ·ç«¯æŒ‰éœ€åŠ è½½ + é¢„åŠ è½½

```typescript
// æ–°å»º projects/app/src/web/i18n/client.ts
import i18next from 'i18next';
import { initReactI18next } from 'react-i18next';
import resourcesToBackend from 'i18next-resources-to-backend';

i18next
  .use(initReactI18next)
  .use(
    resourcesToBackend(
      // åŠ¨æ€å¯¼å…¥ç¿»è¯‘æ–‡ä»¶
      (language: string, namespace: string) =>
        import(`../../../public/locales/${language}/${namespace}.json`)
    )
  )
  .init({
    lng: 'zh',
    fallbackLng: 'en',
    ns: ['common'], // åªé¢„åŠ è½½ common
    defaultNS: 'common',
    // æŒ‰éœ€åŠ è½½å…¶ä»–å‘½åç©ºé—´
    partialBundledLanguages: true,
    react: {
      useSuspense: true, // é…åˆ React Suspense
    },
  });

export default i18next;
```

```typescript
// projects/app/src/pages/_app.tsx
import { Suspense } from 'react';
import { I18nextProvider } from 'react-i18next';
import i18n from '@/web/i18n/client';

function App({ Component, pageProps }) {
  return (
    <I18nextProvider i18n={i18n}>
      <Suspense fallback={<Loading />}>
        <Component {...pageProps} />
      </Suspense>
    </I18nextProvider>
  );
}
```

**é¢„åŠ è½½ç­–ç•¥**ï¼š

```typescript
// projects/app/src/web/i18n/preload.ts
import { useRouter } from 'next/router';
import { useEffect } from 'react';
import i18n from './client';

// é¡µé¢åˆ°å‘½åç©ºé—´çš„æ˜ å°„
const pageNamespaces = {
  '/app/detail': ['app', 'chat', 'workflow'],
  '/dataset/list': ['dataset'],
  '/dashboard/agent': ['app'],
  // ... æ›´å¤šæ˜ å°„
};

export function usePreloadI18n() {
  const router = useRouter();

  useEffect(() => {
    // é¢„åŠ è½½å½“å‰è·¯ç”±çš„å‘½åç©ºé—´
    const namespaces = pageNamespaces[router.pathname] || [];
    namespaces.forEach(ns => {
      i18n.loadNamespaces(ns);
    });

    // é¢„åŠ è½½é“¾æ¥æ‚¬åœæ—¶çš„å‘½åç©ºé—´
    const handleMouseEnter = (e: MouseEvent) => {
      const target = e.target as HTMLElement;
      const link = target.closest('a[href]');
      if (link) {
        const href = link.getAttribute('href');
        const namespaces = pageNamespaces[href] || [];
        namespaces.forEach(ns => i18n.loadNamespaces(ns));
      }
    };

    document.addEventListener('mouseenter', handleMouseEnter, true);
    return () => document.removeEventListener('mouseenter', handleMouseEnter, true);
  }, [router.pathname]);
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ¶ˆé™¤ i18n çš„æœåŠ¡ç«¯åŠ è½½é˜»å¡
- é¦–æ¬¡è®¿é—®ç•¥æ…¢ï¼ˆå¼‚æ­¥åŠ è½½ï¼‰ï¼Œåç»­è·¯ç”±åˆ‡æ¢å¿« 200-300ms
- é…åˆ Service Worker å¯å®ç°ç¦»çº¿ç¿»è¯‘

**å·¥ä½œé‡ä¼°ç®—**ï¼š2-3 å‘¨ï¼Œä¸­ç­‰é£é™©ï¼ˆéœ€è¦å½»åº•æµ‹è¯•ï¼‰

### 5.3 ğŸŸ¡ P1: ä¼˜åŒ– Chakra UI ä½¿ç”¨ï¼ˆé¢„æœŸæ”¹å–„: 15-20%ï¼‰

#### æ–¹æ¡ˆ A: è¿ç§»åˆ° Panda CSS (æ¨èé•¿æœŸæ–¹æ¡ˆ)

Panda CSS æ˜¯ Chakra UI å›¢é˜Ÿå¼€å‘çš„é›¶è¿è¡Œæ—¶ CSS-in-JS æ–¹æ¡ˆï¼š

```bash
pnpm add -D @pandacss/dev
pnpm panda init
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç¼–è¯‘æ—¶ç”Ÿæˆ CSSï¼Œé›¶è¿è¡Œæ—¶å¼€é”€
- âœ… å®Œå…¨ç±»å‹å®‰å…¨
- âœ… ä¸ Chakra UI è¯­æ³•ç›¸ä¼¼ï¼Œè¿ç§»æˆæœ¬ä½
- âœ… æ˜¾è‘—å‡å°‘ bundle å¤§å°

**è¿ç§»ç¤ºä¾‹**ï¼š

```typescript
// æ—§ä»£ç  (Chakra UI)
import { Box, Button } from '@chakra-ui/react';

<Box bg="primary.600" p={4}>
  <Button colorScheme="primary">ç‚¹å‡»</Button>
</Box>

// æ–°ä»£ç  (Panda CSS)
import { css } from '@/styled-system/css';
import { box, button } from '@/styled-system/patterns';

<div className={box({ bg: 'primary.600', p: '4' })}>
  <button className={button({ colorPalette: 'primary' })}>ç‚¹å‡»</button>
</div>
```

**å·¥ä½œé‡ä¼°ç®—**ï¼š6-8 å‘¨ï¼Œé«˜é£é™©ï¼ˆå¤§è§„æ¨¡é‡æ„ï¼‰

#### æ–¹æ¡ˆ B: Chakra UI æŒ‰éœ€å¯¼å…¥ + ä¸»é¢˜ä¼˜åŒ– (å¿«é€Ÿæ”¹å–„)

```typescript
// ä¼˜åŒ–å‰ (packages/web/styles/theme.ts)
import { extendTheme } from '@chakra-ui/react';
// 916 è¡Œä¸»é¢˜é…ç½®

export const theme = extendTheme({
  // å¤§é‡æ ·å¼é…ç½®
});

// ä¼˜åŒ–åï¼šåˆ†ç¦»ä¸»é¢˜æ–‡ä»¶
// packages/web/styles/theme/index.ts
export { theme } from './base';
export { Button } from './components/button';
export { Input } from './components/input';
// ... æŒ‰ç»„ä»¶åˆ†ç¦»

// packages/web/styles/theme/base.ts
import { extendTheme } from '@chakra-ui/react';

export const theme = extendTheme({
  colors: { /* åªåŒ…å«é¢œè‰² */ },
  fonts: { /* åªåŒ…å«å­—ä½“ */ },
  // ç§»é™¤æœªä½¿ç”¨çš„é…ç½®
});

// ä½¿ç”¨ tree-shaking å‹å¥½çš„å¯¼å…¥
// projects/app/src/web/context/ChakraUI.tsx
import { ChakraProvider } from '@chakra-ui/react';
import { theme } from '@fastgpt/web/styles/theme/base';

// åªåœ¨éœ€è¦æ—¶åŠ è½½ç»„ä»¶ä¸»é¢˜
import '@fastgpt/web/styles/theme/components/button';
import '@fastgpt/web/styles/theme/components/input';
```

**æ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼š

```typescript
// projects/app/src/web/context/ChakraUI.tsx
import { ChakraProvider } from '@chakra-ui/react';
import { theme } from '@fastgpt/web/styles/theme';

export const ChakraUIContext = ({ children }: { children: ReactNode }) => {
  return (
    <ChakraProvider
      theme={theme}
      // ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½
      resetCSS={false} // è‡ªå®šä¹‰ reset.scss å·²å¤„ç†
      // ä½¿ç”¨ CSS å˜é‡å‡å°‘è¿è¡Œæ—¶è®¡ç®—
      cssVarsRoot=":root"
    >
      <ColorModeScript initialColorMode={theme.config.initialColorMode} />
      {children}
    </ChakraProvider>
  );
};
```

**é¢„æœŸæ•ˆæœ**ï¼š
- Bundle å¤§å°å‡å°‘ 20-30KB
- é¦–æ¬¡æ¸²æŸ“å¿« 50-100ms
- è·¯ç”±åˆ‡æ¢æ ·å¼æ³¨å…¥å¿« 50-80ms

**å·¥ä½œé‡ä¼°ç®—**ï¼š1-2 å‘¨ï¼Œä½é£é™©

### 5.4 ğŸŸ¡ P1: ä¼˜åŒ– Context æ¶æ„ï¼ˆé¢„æœŸæ”¹å–„: 10-15%ï¼‰

#### æ–¹æ¡ˆ: Context æ‡’åŠ è½½ + ç»†ç²’åº¦åˆ†å‰²

```typescript
// æ–°å»º projects/app/src/web/context/LazyProviders.tsx
import dynamic from 'next/dynamic';
import { Suspense } from 'react';

// æ‡’åŠ è½½éå…³é”® Context
const QueryClientContext = dynamic(() => import('./QueryClient'), {
  ssr: true,
});

const SystemStoreContextProvider = dynamic(
  () => import('@fastgpt/web/context/useSystem'),
  { ssr: true }
);

export function LazyProviders({ children, deviceSize }) {
  return (
    <Suspense fallback={null}>
      <QueryClientContext>
        <SystemStoreContextProvider device={deviceSize}>
          {children}
        </SystemStoreContextProvider>
      </QueryClientContext>
    </Suspense>
  );
}
```

**é¡µé¢çº§ Context ä¼˜åŒ–**ï¼š

```typescript
// projects/app/src/pageComponents/app/detail/context.tsx
import { createContext } from 'use-context-selector';
import { useMemo, useCallback } from 'react';

const AppContextProvider = ({ children }: { children: ReactNode }) => {
  const router = useRouter();
  const { appId, currentTab } = router.query;

  // ä½¿ç”¨ useMemo å‡å°‘ä¸å¿…è¦çš„é‡æ–°åˆ›å»º
  const contextValue = useMemo(
    () => ({
      appId,
      currentTab,
      // ... å…¶ä»–å€¼
    }),
    [appId, currentTab] // åªåœ¨è¿™äº›å€¼å˜åŒ–æ—¶æ›´æ–°
  );

  // ä½¿ç”¨ useCallback ç¼“å­˜å‡½æ•°
  const route2Tab = useCallback(
    (tab: TabEnum) => {
      router.push({
        query: { ...router.query, currentTab: tab }
      });
    },
    [router] // router ç¨³å®šï¼Œä¸ä¼šé¢‘ç¹å˜åŒ–
  );

  // åˆ†ç¦»çŠ¶æ€åˆ°ç‹¬ç«‹ Context
  return (
    <AppContext.Provider value={contextValue}>
      <AppDataProvider appId={appId}>
        <AppActionsProvider>
          {children}
        </AppActionsProvider>
      </AppDataProvider>
    </AppContext.Provider>
  );
};
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“
- Context åˆå§‹åŒ–æ—¶é—´å‡å°‘ 50-100ms
- å†…å­˜å ç”¨é™ä½

**å·¥ä½œé‡ä¼°ç®—**ï¼š2-3 å‘¨ï¼Œä¸­ç­‰é£é™©

### 5.5 ğŸŸ¡ P1: å¼€å‘ç¯å¢ƒä¼˜åŒ–ï¼ˆé¢„æœŸæ”¹å–„: 30-40% å¼€å‘ç¯å¢ƒï¼‰

#### é…ç½®ä¼˜åŒ–

```javascript
// projects/app/next.config.js
const nextConfig = {
  // ... ç°æœ‰é…ç½®

  // å¼€å‘ç¯å¢ƒä¸“ç”¨ä¼˜åŒ–
  ...(isDev && {
    // ç¦ç”¨ source mapï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€è¦ï¼‰
    // productionBrowserSourceMaps: false,

    // ä¼˜åŒ–ç¼–è¯‘æ€§èƒ½
    swcMinify: true, // ä½¿ç”¨ SWC å‹ç¼©ï¼ˆç”Ÿäº§ç¯å¢ƒå·²é»˜è®¤ï¼‰

    // å‡å°‘ç±»å‹æ£€æŸ¥é¢‘ç‡
    typescript: {
      // åœ¨æ„å»ºæ—¶å¿½ç•¥ç±»å‹é”™è¯¯ï¼ˆå¼€å‘ä¸­ï¼‰
      // æ³¨æ„ï¼šè¿™ä¼šé™ä½ç±»å‹å®‰å…¨æ€§
      ignoreBuildErrors: isDev,
    },

    // ä¼˜åŒ– webpack é…ç½®
    webpack(config, { isServer, dev }) {
      if (dev && !isServer) {
        // ä½¿ç”¨æ›´å¿«çš„ source map
        config.devtool = 'eval-cheap-module-source-map';

        // å‡å°‘æ–‡ä»¶ç›‘å¬èŒƒå›´
        config.watchOptions = {
          ...config.watchOptions,
          ignored: [
            '**/node_modules',
            '**/.git',
            '**/dist',
            '**/coverage'
          ],
        };

        // å¯ç”¨æŒä¹…åŒ–ç¼“å­˜
        config.cache = {
          type: 'filesystem',
          buildDependencies: {
            config: [__filename],
          },
        };
      }

      return config;
    },
  }),
};
```

#### Turbopack è¿ç§»ï¼ˆå®éªŒæ€§ï¼‰

Next.js 14 æ”¯æŒ Turbopackï¼ˆRust å®ç°çš„æ‰“åŒ…å™¨ï¼‰ï¼š

```json
// package.json
{
  "scripts": {
    "dev": "next dev --turbo",
    "dev:webpack": "next dev"
  }
}
```

**æ³¨æ„**ï¼šTurbopack ä»åœ¨å®éªŒé˜¶æ®µï¼Œå¯èƒ½å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ã€‚

#### TypeScript é¡¹ç›®å¼•ç”¨

ä¼˜åŒ– monorepo çš„ TypeScript ç¼–è¯‘ï¼š

```json
// tsconfig.json (æ ¹ç›®å½•)
{
  "compilerOptions": {
    "composite": true,
    "incremental": true,
    "tsBuildInfoFile": ".tsbuildinfo"
  },
  "references": [
    { "path": "./packages/global" },
    { "path": "./packages/service" },
    { "path": "./packages/web" },
    { "path": "./projects/app" }
  ]
}

// projects/app/tsconfig.json
{
  "extends": "../../tsconfig.json",
  "compilerOptions": {
    "composite": true,
    "incremental": true
  },
  "references": [
    { "path": "../../packages/global" },
    { "path": "../../packages/service" },
    { "path": "../../packages/web" }
  ]
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- TypeScript ç¼–è¯‘é€Ÿåº¦æå‡ 50-70%
- HMR å“åº”æ—¶é—´å‡å°‘ 40-60%
- é¦–æ¬¡å¯åŠ¨æ—¶é—´å‡å°‘ 30-50%

**å·¥ä½œé‡ä¼°ç®—**ï¼š1 å‘¨ï¼Œä½é£é™©

### 5.6 ğŸŸ¢ P2: ä»£ç åˆ†å‰²ä¼˜åŒ–ï¼ˆé¢„æœŸæ”¹å–„: 10-15%ï¼‰

#### æ‰©å¤§ dynamic() ä½¿ç”¨èŒƒå›´

```typescript
// è¯†åˆ«å¤§å‹ç»„ä»¶å¹¶åŠ¨æ€åŠ è½½
// projects/app/src/components/Layout.tsx
import dynamic from 'next/dynamic';

const Sidebar = dynamic(() => import('./Sidebar'), {
  loading: () => <SidebarSkeleton />,
});

const Header = dynamic(() => import('./Header'), {
  loading: () => <HeaderSkeleton />,
});

export default function Layout({ children }) {
  return (
    <div>
      <Header />
      <Sidebar />
      <main>{children}</main>
    </div>
  );
}
```

#### è·¯ç”±çº§åˆ«çš„é¢„åŠ è½½

```typescript
// projects/app/src/components/common/Link.tsx
import NextLink from 'next/link';
import { useRouter } from 'next/router';

export function Link({ href, children, ...props }) {
  const router = useRouter();

  const handleMouseEnter = () => {
    // é¢„åŠ è½½è·¯ç”±
    router.prefetch(href);
  };

  return (
    <NextLink href={href} {...props} onMouseEnter={handleMouseEnter}>
      {children}
    </NextLink>
  );
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- Bundle å¤§å°å‡å°‘ 15-25%
- åˆå§‹åŠ è½½æ—¶é—´å‡å°‘ 100-200ms
- åç»­é¡µé¢åŠ è½½å‡ ä¹å³æ—¶ï¼ˆé¢„åŠ è½½ï¼‰

**å·¥ä½œé‡ä¼°ç®—**ï¼š2-3 å‘¨ï¼Œä½é£é™©

### 5.7 ğŸŸ¢ P2: æ•°æ®è·å–ä¼˜åŒ–ï¼ˆé¢„æœŸæ”¹å–„: 5-10%ï¼‰

#### ç»Ÿä¸€æ•°æ®å±‚

```typescript
// æ–°å»º projects/app/src/web/data/queryClient.ts
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 åˆ†é’Ÿå†…æ•°æ®è¢«è§†ä¸ºæ–°é²œ
      cacheTime: 10 * 60 * 1000, // 10 åˆ†é’Ÿç¼“å­˜
      refetchOnWindowFocus: false,
      retry: 1,
    },
  },
});

// é¢„å®šä¹‰æŸ¥è¯¢é”®
export const queryKeys = {
  appDetail: (id: string) => ['app', 'detail', id] as const,
  datasetList: (parentId?: string) => ['dataset', 'list', parentId] as const,
  // ... æ›´å¤šæŸ¥è¯¢é”®
};
```

```typescript
// ä½¿ç”¨ç¤ºä¾‹
// projects/app/src/pageComponents/app/detail/context.tsx
import { useQuery } from '@tanstack/react-query';
import { queryKeys } from '@/web/data/queryClient';

const AppContextProvider = ({ children }: { children: ReactNode }) => {
  const router = useRouter();
  const { appId } = router.query as { appId: string };

  const { data: appDetail, isLoading } = useQuery({
    queryKey: queryKeys.appDetail(appId),
    queryFn: () => getAppDetailById(appId),
    enabled: !!appId,
    // ä½¿ç”¨åˆå§‹æ•°æ®ï¼ˆä» SSR ä¼ é€’ï¼‰
    initialData: () => {
      // å°è¯•ä»ç¼“å­˜æˆ– SSR props è·å–
      return queryClient.getQueryData(queryKeys.appDetail(appId));
    },
  });

  // ... å…¶ä½™é€»è¾‘
};
```

#### SSR æ•°æ®ä¼ é€’

```typescript
// projects/app/src/pages/app/detail/index.tsx
import { dehydrate, QueryClient } from '@tanstack/react-query';
import { queryKeys } from '@/web/data/queryClient';

export async function getServerSideProps(context: any) {
  const { appId } = context.query;
  const queryClient = new QueryClient();

  // é¢„å¡«å……æŸ¥è¯¢ç¼“å­˜
  await queryClient.prefetchQuery({
    queryKey: queryKeys.appDetail(appId),
    queryFn: () => getAppDetailById(appId),
  });

  return {
    props: {
      dehydratedState: dehydrate(queryClient),
      ...(await serviceSideProps(context, ['app', 'chat']))
    }
  };
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- æ¶ˆé™¤é‡å¤è¯·æ±‚
- æ•°æ®ä¸€è‡´æ€§æå‡
- æ›´å¥½çš„ç¼“å­˜åˆ©ç”¨

**å·¥ä½œé‡ä¼°ç®—**ï¼š2-3 å‘¨ï¼Œä¸­ç­‰é£é™©

---

## 6. å®æ–½è·¯çº¿å›¾

### Phase 1: å¿«é€Ÿèƒœåˆ©ï¼ˆ1-2 å‘¨ï¼‰

**ç›®æ ‡**ï¼šåœ¨ä¸æ”¹å˜æ¶æ„çš„æƒ…å†µä¸‹å¿«é€Ÿæ”¹å–„ 30-40%

```
Week 1:
â”œâ”€ å‘¨ä¸€-å‘¨äºŒ: è¯†åˆ«å¯æ”¹ä¸º CSR çš„é¡µé¢
â”œâ”€ å‘¨ä¸‰-å‘¨å››: ç§»é™¤éå¿…è¦é¡µé¢çš„ getServerSideProps
â”œâ”€ å‘¨äº”: æµ‹è¯•å’ŒéªŒè¯

Week 2:
â”œâ”€ å‘¨ä¸€-å‘¨ä¸‰: Chakra UI æŒ‰éœ€å¯¼å…¥å’Œä¸»é¢˜ä¼˜åŒ–
â”œâ”€ å‘¨å››: å¼€å‘ç¯å¢ƒé…ç½®ä¼˜åŒ–
â””â”€ å‘¨äº”: æ€§èƒ½æµ‹è¯•å’Œæ–‡æ¡£
```

**é¢„æœŸæ”¹å–„**ï¼š
- å¼€å‘ç¯å¢ƒè·¯ç”±åˆ‡æ¢: 1560ms â†’ 900ms (42%â†“)
- ç”Ÿäº§ç¯å¢ƒè·¯ç”±åˆ‡æ¢: 650ms â†’ 450ms (31%â†“)

### Phase 2: æ ¸å¿ƒä¼˜åŒ–ï¼ˆ3-4 å‘¨ï¼‰

**ç›®æ ‡**ï¼šè§£å†³æ¶æ„ç“¶é¢ˆï¼Œæ”¹å–„ 50-60%

```
Week 3-4:
â”œâ”€ i18n å®¢æˆ·ç«¯æŒ‰éœ€åŠ è½½å®æ–½
â”œâ”€ Context æ¶æ„é‡æ„
â””â”€ æ•°æ®è·å–å±‚ç»Ÿä¸€

Week 5:
â”œâ”€ ä»£ç åˆ†å‰²æ‰©å±•
â”œâ”€ é¢„åŠ è½½ç­–ç•¥å®æ–½
â””â”€ ç«¯åˆ°ç«¯æ€§èƒ½æµ‹è¯•
```

**é¢„æœŸæ”¹å–„**ï¼š
- å¼€å‘ç¯å¢ƒè·¯ç”±åˆ‡æ¢: 900ms â†’ 500ms (é¢å¤– 44%â†“)
- ç”Ÿäº§ç¯å¢ƒè·¯ç”±åˆ‡æ¢: 450ms â†’ 280ms (é¢å¤– 38%â†“)

### Phase 3: é•¿æœŸæ¼”è¿›ï¼ˆ2-3 ä¸ªæœˆï¼‰

**ç›®æ ‡**ï¼šæ¶æ„ç°ä»£åŒ–ï¼Œè¾¾åˆ°æœ€ä½³æ€§èƒ½

```
Month 2:
â”œâ”€ App Router è¿ç§»æ–¹æ¡ˆè®¾è®¡
â”œâ”€ åˆ›å»º app/ ç›®å½•
â””â”€ é™æ€é¡µé¢è¿ç§»

Month 3:
â”œâ”€ åŠ¨æ€é¡µé¢è¿ç§»
â”œâ”€ æ•°æ®è·å–æ¨¡å¼é‡æ„
â””â”€ å…¨é¢æ€§èƒ½æµ‹è¯•

Month 4:
â”œâ”€ Panda CSS è¿ç§»è¯„ä¼°
â”œâ”€ å…³é”®é¡µé¢è¿ç§»
â””â”€ å…¨é‡è¿ç§»æˆ–ä¿ç•™æ··åˆæ¨¡å¼
```

**é¢„æœŸæ”¹å–„**ï¼š
- è·¯ç”±åˆ‡æ¢: < 200msï¼ˆæ¥è¿‘å³æ—¶ï¼‰
- é¦–æ¬¡åŠ è½½: < 1.5s (LCP)
- äº¤äº’å°±ç»ª: < 2s (TTI)

---

## 7. ç›‘æ§å’Œåº¦é‡

### 7.1 æ€§èƒ½æŒ‡æ ‡

å»ºè®®é›†æˆ Web Vitals ç›‘æ§ï¼š

```typescript
// projects/app/src/pages/_app.tsx
import { useEffect } from 'react';
import { useRouter } from 'next/router';

export function reportWebVitals(metric) {
  // å‘é€åˆ°åˆ†ææœåŠ¡
  if (metric.label === 'web-vital') {
    console.log(metric);

    // å‘é€åˆ°è‡ªå®šä¹‰åˆ†æç«¯ç‚¹
    fetch('/api/analytics', {
      method: 'POST',
      body: JSON.stringify(metric),
      headers: { 'Content-Type': 'application/json' },
    });
  }
}

function App({ Component, pageProps }) {
  const router = useRouter();

  useEffect(() => {
    const handleRouteChange = (url: string, { shallow }) => {
      // è®°å½•è·¯ç”±åˆ‡æ¢å¼€å§‹
      performance.mark('route-change-start');
    };

    const handleRouteComplete = (url: string) => {
      // è®°å½•è·¯ç”±åˆ‡æ¢å®Œæˆ
      performance.mark('route-change-end');
      performance.measure(
        'route-change',
        'route-change-start',
        'route-change-end'
      );

      const measure = performance.getEntriesByName('route-change')[0];
      console.log(`Route change took ${measure.duration}ms`);

      // å‘é€åˆ°åˆ†ææœåŠ¡
      fetch('/api/analytics/route', {
        method: 'POST',
        body: JSON.stringify({
          url,
          duration: measure.duration,
        }),
      });
    };

    router.events.on('routeChangeStart', handleRouteChange);
    router.events.on('routeChangeComplete', handleRouteComplete);

    return () => {
      router.events.off('routeChangeStart', handleRouteChange);
      router.events.off('routeChangeComplete', handleRouteComplete);
    };
  }, [router]);

  return <Component {...pageProps} />;
}
```

### 7.2 å…³é”®æŒ‡æ ‡ç›®æ ‡

```yaml
æ ¸å¿ƒ Web Vitals:
  LCP (Largest Contentful Paint): < 2.5s
  FID (First Input Delay): < 100ms
  CLS (Cumulative Layout Shift): < 0.1

è‡ªå®šä¹‰æŒ‡æ ‡:
  è·¯ç”±åˆ‡æ¢æ—¶é—´: < 300ms
  é¦–æ¬¡å†…å®¹ç»˜åˆ¶ (FCP): < 1.5s
  äº¤äº’å°±ç»ªæ—¶é—´ (TTI): < 3.5s

å¼€å‘ç¯å¢ƒ:
  HMR å“åº”: < 500ms
  é¦–æ¬¡ç¼–è¯‘: < 30s
  å¢é‡ç¼–è¯‘: < 5s
```

---

## 8. é£é™©è¯„ä¼°

### 8.1 æŠ€æœ¯é£é™©

| ä¼˜åŒ–é¡¹ | é£é™©ç­‰çº§ | é£é™©æè¿° | ç¼“è§£æªæ–½ |
|--------|---------|---------|---------|
| ç§»é™¤ getServerSideProps | ğŸŸ¡ ä¸­ | SEO å½±å“ã€é¦–å±æ…¢ | ä¿ç•™å…³é”®é¡µé¢ SSRï¼ŒA/B æµ‹è¯• |
| i18n å®¢æˆ·ç«¯åŒ– | ğŸŸ¡ ä¸­ | ç¿»è¯‘é—ªçƒã€åŠ è½½å¤±è´¥ | Suspense + fallbackï¼ŒService Worker |
| App Router è¿ç§» | ğŸ”´ é«˜ | å¤§è§„æ¨¡é‡æ„ã€å…¼å®¹æ€§ | æ¸è¿›å¼è¿ç§»ï¼Œä¿ç•™ pages/ åå¤‡ |
| Panda CSS è¿ç§» | ğŸ”´ é«˜ | æ ·å¼ä¸ä¸€è‡´ã€å·¥ä½œé‡å¤§ | åˆ†é˜¶æ®µè¿ç§»ï¼Œç»„ä»¶çº§æ›¿æ¢ |

### 8.2 ä¸šåŠ¡é£é™©

- **ç”¨æˆ·ä½“éªŒä¸‹é™**ï¼šä¼˜åŒ–ä¸å½“å¯èƒ½å¯¼è‡´é¦–å±æ›´æ…¢
  - **ç¼“è§£**ï¼šç°åº¦å‘å¸ƒï¼Œç›‘æ§æŒ‡æ ‡å›é€€æœºåˆ¶

- **å¼€å‘æ•ˆç‡å½±å“**ï¼šå¤§è§„æ¨¡é‡æ„å¯èƒ½é˜»å¡åŠŸèƒ½å¼€å‘
  - **ç¼“è§£**ï¼šåˆ†é˜¶æ®µå®æ–½ï¼Œä¿æŒä¸»åˆ†æ”¯ç¨³å®š

- **å‘åå…¼å®¹æ€§**ï¼šè€ç‰ˆæœ¬æµè§ˆå™¨æ”¯æŒ
  - **ç¼“è§£**ï¼šä¿ç•™ polyfillsï¼Œç›‘æ§æµè§ˆå™¨åˆ†å¸ƒ

---

## 9. æˆæœ¬æ”¶ç›Šåˆ†æ

### 9.1 æŠ•å…¥ä¼°ç®—

| é˜¶æ®µ | å·¥ä½œé‡ | äººåŠ›éœ€æ±‚ | æ—¶é—´çº¿ |
|------|-------|---------|--------|
| Phase 1 | 80h | 2 åå‰ç«¯ | 2 å‘¨ |
| Phase 2 | 160h | 2 åå‰ç«¯ | 4 å‘¨ |
| Phase 3 | 320h | 2-3 åå‰ç«¯ | 3 ä¸ªæœˆ |
| **æ€»è®¡** | **560h** | **2-3 äºº** | **4 ä¸ªæœˆ** |

### 9.2 æ”¶ç›Šé¢„æµ‹

**å®šé‡æ”¶ç›Š**ï¼š
- ç”¨æˆ·ä½“éªŒæ”¹å–„ â†’ ç”¨æˆ·ç•™å­˜ç‡æå‡ 2-5%
- æœåŠ¡ç«¯è´Ÿè½½é™ä½ â†’ æœåŠ¡å™¨æˆæœ¬èŠ‚çœ 30-40%
- å¼€å‘æ•ˆç‡æå‡ â†’ è¿­ä»£é€Ÿåº¦åŠ å¿« 20-30%

**å®šæ€§æ”¶ç›Š**ï¼š
- æŠ€æœ¯å€ºåŠ¡å‡å°‘
- ä»£ç å¯ç»´æŠ¤æ€§æå‡
- å›¢é˜Ÿæ»¡æ„åº¦æé«˜

---

## 10. ç»“è®º

FastGPT çš„è·¯ç”±æ€§èƒ½é—®é¢˜æ˜¯å¤šæ–¹é¢å› ç´ å…±åŒä½œç”¨çš„ç»“æœï¼Œæ ¸å¿ƒåœ¨äºï¼š

1. **è¿‡åº¦ä¾èµ– SSR**ï¼šæ‰€æœ‰é¡µé¢éƒ½ä½¿ç”¨ getServerSidePropsï¼Œå¯¼è‡´æœåŠ¡ç«¯é˜»å¡
2. **åºå¤§çš„ä»£ç åº“**ï¼š314 ä¸ªé¡µé¢ç»„ä»¶ç¼ºä¹æœ‰æ•ˆçš„ä»£ç åˆ†å‰²
3. **å›½é™…åŒ–é˜»å¡**ï¼ši18n åœ¨æœåŠ¡ç«¯åŒæ­¥åŠ è½½å¤šä¸ªå‘½åç©ºé—´
4. **CSS-in-JS å¼€é”€**ï¼šChakra UI çš„è¿è¡Œæ—¶æ ·å¼è®¡ç®—
5. **å¼€å‘ç¯å¢ƒæœªä¼˜åŒ–**ï¼šMonorepo ç›‘å¬èŒƒå›´å¹¿ã€TypeScript ç¼–è¯‘æ…¢

**æ¨èä¼˜å…ˆçº§**ï¼š

```
ç«‹å³è¡ŒåŠ¨ (1-2 å‘¨):
âœ… ç§»é™¤éå¿…è¦é¡µé¢çš„ getServerSideProps
âœ… Chakra UI æŒ‰éœ€å¯¼å…¥
âœ… å¼€å‘ç¯å¢ƒé…ç½®ä¼˜åŒ–

çŸ­æœŸæ”¹å–„ (1-2 ä¸ªæœˆ):
âœ… i18n å®¢æˆ·ç«¯æŒ‰éœ€åŠ è½½
âœ… Context æ¶æ„ä¼˜åŒ–
âœ… ç»Ÿä¸€æ•°æ®è·å–å±‚

é•¿æœŸè§„åˆ’ (3-4 ä¸ªæœˆ):
âš ï¸ App Router è¿ç§»
âš ï¸ Panda CSS è¯„ä¼°
```

é€šè¿‡ç³»ç»Ÿæ€§çš„ä¼˜åŒ–ï¼Œé¢„æœŸå¯ä»¥å°†è·¯ç”±åˆ‡æ¢æ—¶é—´ä»å½“å‰çš„ **1560msï¼ˆå¼€å‘ç¯å¢ƒï¼‰é™ä½åˆ° 200-300ms**ï¼Œè¾¾åˆ°ç”¨æˆ·æ— æ„ŸçŸ¥çš„æ°´å¹³ã€‚

---

## é™„å½•

### A. æ€§èƒ½æµ‹è¯•è„šæœ¬

```typescript
// projects/app/test/performance/route-switching.test.ts
import { test, expect } from '@playwright/test';

test.describe('Route Switching Performance', () => {
  test('should switch routes within 500ms', async ({ page }) => {
    await page.goto('http://localhost:3000/dashboard/agent');

    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
    await page.waitForLoadState('networkidle');

    // è®°å½•è·¯ç”±åˆ‡æ¢æ—¶é—´
    const startTime = Date.now();

    // ç‚¹å‡»é“¾æ¥
    await page.click('a[href="/app/detail?appId=xxx"]');

    // ç­‰å¾…æ–°é¡µé¢åŠ è½½
    await page.waitForSelector('[data-testid="app-detail-page"]');

    const endTime = Date.now();
    const duration = endTime - startTime;

    console.log(`Route switching took ${duration}ms`);
    expect(duration).toBeLessThan(500);
  });
});
```

### B. Bundle åˆ†æå‘½ä»¤

```json
// package.json
{
  "scripts": {
    "analyze": "ANALYZE=true next build",
    "analyze:bundle": "npx @next/bundle-analyzer"
  }
}
```

```javascript
// next.config.js
const withBundleAnalyzer = require('@next/bundle-analyzer')({
  enabled: process.env.ANALYZE === 'true',
});

module.exports = withBundleAnalyzer(nextConfig);
```

### C. å‚è€ƒèµ„æº

- [Next.js Performance Best Practices](https://nextjs.org/docs/app/building-your-application/optimizing)
- [Web Vitals Guide](https://web.dev/vitals/)
- [React Query Performance Tips](https://tanstack.com/query/latest/docs/react/guides/performance)
- [Chakra UI Performance](https://chakra-ui.com/docs/styled-system/performance)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-18
**åˆ†æäººå‘˜**: Claude Code (SuperClaude Framework)
**é¡¹ç›®ç‰ˆæœ¬**: v4.13.1

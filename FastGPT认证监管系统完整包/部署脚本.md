# FastGPT 认证监管系统 - 快速部署脚本

## 🚀 一键部署脚本

### Windows 一键部署 (deploy-windows.bat)

```batch
@echo off
echo ================================
echo FastGPT 认证监管系统部署脚本
echo ================================

echo 检查 Node.js 环境...
node --version >nul 2>&1
if errorlevel 1 (
    echo ❌ 未检测到 Node.js，请先安装 Node.js
    pause
    exit /b 1
)

echo ✅ Node.js 环境正常

echo 检查 FastGPT 服务...
curl -s http://localhost:3000 >nul 2>&1
if errorlevel 1 (
    echo ❌ FastGPT 未运行，请先启动 FastGPT 服务
    pause
    exit /b 1
)

echo ✅ FastGPT 服务正常

echo 安装依赖包...
npm install express cors

echo 启动用户管理系统...
start "用户管理系统" cmd /k "echo 用户管理系统启动中... && node simple-server.js"

echo 等待用户管理系统启动...
timeout /t 3 /nobreak

echo 启动认证代理服务器...
start "认证代理服务器" cmd /k "echo 认证代理服务器启动中... && node fixed-proxy.js"

echo 等待服务启动完成...
timeout /t 3 /nobreak

echo ================================
echo 🎉 部署完成！
echo ================================
echo 📍 认证代理地址: http://localhost:3001
echo 📍 用户管理系统: http://localhost:3002
echo 📍 测试页面: 打开 认证代理.html
echo ================================

echo 现在您可以：
echo 1. 将原来的分享链接端口从 3000 改为 3001
echo 2. 打开测试页面验证系统功能
echo 3. 访问管理后台查看用户和聊天记录

pause
```

### Linux/macOS 一键部署 (deploy-unix.sh)

```bash
#!/bin/bash

echo "================================"
echo "FastGPT 认证监管系统部署脚本"
echo "================================"

# 检查 Node.js
if ! command -v node &> /dev/null; then
    echo "❌ 未检测到 Node.js，请先安装 Node.js"
    exit 1
fi
echo "✅ Node.js 环境正常"

# 检查 FastGPT 服务
if ! curl -s http://localhost:3000 > /dev/null; then
    echo "❌ FastGPT 未运行，请先启动 FastGPT 服务"
    exit 1
fi
echo "✅ FastGPT 服务正常"

# 安装依赖
echo "安装依赖包..."
npm install express cors

# 启动用户管理系统
echo "启动用户管理系统..."
nohup node simple-server.js > user-system.log 2>&1 &
USER_SYSTEM_PID=$!

sleep 3

# 启动认证代理服务器
echo "启动认证代理服务器..."
nohup node fixed-proxy.js > auth-proxy.log 2>&1 &
AUTH_PROXY_PID=$!

sleep 3

echo "================================"
echo "🎉 部署完成！"
echo "================================"
echo "📍 认证代理地址: http://localhost:3001"
echo "📍 用户管理系统: http://localhost:3002"
echo "📍 用户管理系统PID: $USER_SYSTEM_PID"
echo "📍 认证代理PID: $AUTH_PROXY_PID"
echo "================================"

echo "现在您可以："
echo "1. 将原来的分享链接端口从 3000 改为 3001"
echo "2. 打开测试页面验证系统功能"
echo "3. 访问管理后台查看用户和聊天记录"

echo ""
echo "停止服务命令："
echo "kill $USER_SYSTEM_PID $AUTH_PROXY_PID"
```

## 📦 Docker 部署

### docker-compose.yml

```yaml
version: '3.8'

services:
  # 原始 FastGPT 服务（假设已存在）
  fastgpt:
    image: ghcr.io/labring/fastgpt:v4.10.0-fix
    container_name: fastgpt
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    networks:
      - fastgpt-network

  # 用户管理系统
  user-management:
    build: 
      context: .
      dockerfile: Dockerfile.user-system
    container_name: fastgpt-user-system
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - JWT_SECRET=your-super-secret-jwt-key
    volumes:
      - ./data:/app/data
    networks:
      - fastgpt-network
    depends_on:
      - fastgpt

  # 认证代理服务器
  auth-proxy:
    build:
      context: .
      dockerfile: Dockerfile.auth-proxy
    container_name: fastgpt-auth-proxy
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - FASTGPT_URL=http://fastgpt:3000
      - USER_SYSTEM_URL=http://user-management:3002
    networks:
      - fastgpt-network
    depends_on:
      - fastgpt
      - user-management

networks:
  fastgpt-network:
    driver: bridge
```

### Dockerfile.user-system

```dockerfile
FROM node:16-alpine

WORKDIR /app

# 复制依赖文件
COPY package*.json ./
RUN npm install --production

# 复制源代码
COPY simple-server.js .
COPY login.html .
COPY admin.html .

# 创建数据目录
RUN mkdir -p /app/data

EXPOSE 3002

CMD ["node", "simple-server.js"]
```

### Dockerfile.auth-proxy

```dockerfile
FROM node:16-alpine

WORKDIR /app

# 复制依赖文件
COPY package*.json ./
RUN npm install --production

# 复制源代码
COPY fixed-proxy.js .

EXPOSE 3001

CMD ["node", "fixed-proxy.js"]
```

## 🔧 环境配置

### package.json

```json
{
  "name": "fastgpt-auth-system",
  "version": "1.0.0",
  "description": "FastGPT 认证监管系统",
  "main": "index.js",
  "scripts": {
    "start": "node simple-server.js",
    "start:proxy": "node fixed-proxy.js",
    "start:all": "concurrently \"npm run start\" \"npm run start:proxy\"",
    "test": "node test/test-system.js",
    "dev": "nodemon simple-server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5"
  },
  "devDependencies": {
    "nodemon": "^3.0.1",
    "concurrently": "^8.2.2"
  },
  "keywords": [
    "fastgpt",
    "authentication",
    "proxy",
    "monitoring"
  ],
  "author": "Your Name",
  "license": "MIT"
}
```

### 环境变量配置 (.env)

```bash
# 服务端口配置
PROXY_PORT=3001
USER_SYSTEM_PORT=3002
FASTGPT_PORT=3000

# JWT 配置
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_EXPIRES_IN=24h

# 数据库配置（可选）
DB_HOST=localhost
DB_PORT=3306
DB_USER=fastgpt_user
DB_PASSWORD=your-db-password
DB_NAME=fastgpt_auth

# 系统配置
NODE_ENV=production
ENABLE_REGISTRATION=true
ENABLE_SCRIPT_INJECTION=true
DEBUG_MODE=false

# 安全配置
CORS_ORIGIN=*
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100
```

## 🔍 系统检查脚本

### system-check.js

```javascript
const http = require('http');

// 系统检查脚本
async function checkSystem() {
    console.log('🔍 FastGPT 认证监管系统检查开始...\n');
    
    const checks = [
        { name: 'FastGPT 服务', url: 'http://localhost:3000', port: 3000 },
        { name: '用户管理系统', url: 'http://localhost:3002', port: 3002 },
        { name: '认证代理服务器', url: 'http://localhost:3001', port: 3001 }
    ];
    
    for (const check of checks) {
        try {
            await checkService(check.url);
            console.log(`✅ ${check.name} (端口 ${check.port}) - 正常运行`);
        } catch (error) {
            console.log(`❌ ${check.name} (端口 ${check.port}) - 服务异常`);
            console.log(`   错误: ${error.message}`);
        }
    }
    
    console.log('\n🔍 系统检查完成');
}

function checkService(url) {
    return new Promise((resolve, reject) => {
        const req = http.get(url, (res) => {
            resolve(res.statusCode);
        });
        
        req.on('error', (error) => {
            reject(error);
        });
        
        req.setTimeout(5000, () => {
            req.destroy();
            reject(new Error('请求超时'));
        });
    });
}

if (require.main === module) {
    checkSystem();
}

module.exports = { checkSystem };
```

## 📋 部署检查清单

### 部署前检查
- [ ] Node.js 已安装 (版本 14.0+)
- [ ] FastGPT 正常运行在端口 3000
- [ ] 端口 3001 和 3002 可用
- [ ] 必要的依赖包已安装

### 部署后验证
- [ ] 用户管理系统启动成功 (端口 3002)
- [ ] 认证代理服务器启动成功 (端口 3001)
- [ ] 测试页面可以正常访问
- [ ] 登录注册功能正常
- [ ] 分享链接重定向正常
- [ ] 聊天监控功能工作

### 生产环境额外检查
- [ ] 更改默认管理员密码
- [ ] 配置 HTTPS 证书
- [ ] 设置环境变量
- [ ] 配置数据库连接
- [ ] 设置定期备份
- [ ] 配置监控告警

## 🚨 故障恢复

### 服务重启脚本 (restart-services.bat)

```batch
@echo off
echo 正在重启 FastGPT 认证监管系统...

echo 停止现有服务...
taskkill /F /IM node.exe /FI "WINDOWTITLE eq 用户管理系统*"
taskkill /F /IM node.exe /FI "WINDOWTITLE eq 认证代理服务器*"

timeout /t 2 /nobreak

echo 重启用户管理系统...
start "用户管理系统" cmd /k "node simple-server.js"

timeout /t 3 /nobreak

echo 重启认证代理服务器...
start "认证代理服务器" cmd /k "node fixed-proxy.js"

echo 服务重启完成！
pause
```

---

**注意**: 请根据您的实际环境调整脚本中的路径和配置参数。生产环境部署时务必修改默认密码和密钥。

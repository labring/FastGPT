<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«é“¾æ¥è®¤è¯ä»£ç†</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.6);
        }
        .warning {
            background: rgba(255, 193, 7, 0.3);
            border: 1px solid rgba(255, 193, 7, 0.6);
        }
        .error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid rgba(244, 67, 54, 0.6);
        }
        .btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        .btn.info {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        .logs {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .share-link {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” FastGPT åˆ†äº«é“¾æ¥è®¤è¯ä»£ç†</h1>
        
        <div id="status" class="status warning">
            æ­£åœ¨æ£€æµ‹ç³»ç»ŸçŠ¶æ€...
        </div>

        <div class="share-link">
            <strong>âš ï¸ é‡è¦ï¼šç°åœ¨ä½¿ç”¨ç«¯å£ 3001</strong><br>
            <span id="shareLink">http://localhost:3001/chat/share?shareId=xCzw733YQ36MdQ4ieqQfQIHU</span>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="checkAuth()">ğŸ” æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
            <button class="btn info" onclick="loginTest()">ğŸ”‘ æµ‹è¯•ç™»å½•</button>
            <button class="btn" onclick="proxyAccess()">ğŸš€ ä»£ç†è®¿é—®åˆ†äº«é“¾æ¥</button>
            <button class="btn danger" onclick="clearData()">ğŸ—‘ï¸ æ¸…é™¤æ•°æ®</button>
        </div>

        <div class="logs" id="logs"></div>

        <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
            <strong>ä½¿ç”¨è¯´æ˜:</strong>
            <ol>
                <li>ç‚¹å‡»"æ£€æŸ¥è®¤è¯çŠ¶æ€"æŸ¥çœ‹å½“å‰ç”¨æˆ·çŠ¶æ€</li>
                <li>å¦‚æœæœªç™»å½•ï¼Œç‚¹å‡»"æµ‹è¯•ç™»å½•"è¿›è¡Œç™»å½•</li>
                <li>ç™»å½•åç‚¹å‡»"ä»£ç†è®¿é—®åˆ†äº«é“¾æ¥"è¿›å…¥å—ä¿æŠ¤çš„åˆ†äº«é¡µé¢</li>
                <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•ç”¨æˆ·çš„æ‰€æœ‰èŠå¤©è¡Œä¸º</li>
            </ol>
        </div>
    </div>

    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = logs.slice(-10).join('\n');
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(logMessage);
        }

        function updateStatus(message, type = 'warning') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        async function checkAuth() {
            log('æ­£åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€...');
            
            const userToken = localStorage.getItem('shareUserToken');
            const userInfo = localStorage.getItem('shareUserInfo');
            
            if (userToken && userInfo) {
                try {
                    // éªŒè¯tokenæœ‰æ•ˆæ€§
                    const response = await fetch('http://localhost:3002/api/user/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${userToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const userData = JSON.parse(userInfo);
                        updateStatus(`âœ… ç”¨æˆ·å·²è®¤è¯: ${userData.username} (${userData.email})`, 'success');
                        log(`è®¤è¯æˆåŠŸ - ç”¨æˆ·: ${userData.username}`);
                        return true;
                    } else {
                        throw new Error('TokenéªŒè¯å¤±è´¥');
                    }
                } catch (error) {
                    log(`è®¤è¯éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                    localStorage.removeItem('shareUserToken');
                    localStorage.removeItem('shareUserInfo');
                    updateStatus('âŒ è®¤è¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    return false;
                }
            } else {
                updateStatus('âš ï¸ ç”¨æˆ·æœªç™»å½•', 'warning');
                log('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯');
                return false;
            }
        }

        async function loginTest() {
            log('å¼€å§‹æµ‹è¯•ç™»å½•...');
            
            // è·³è½¬åˆ°ç”¨æˆ·ç®¡ç†ç³»ç»Ÿè¿›è¡Œç™»å½•
            const currentUrl = window.location.href;
            const redirectUrl = encodeURIComponent(currentUrl);
            const loginUrl = `http://localhost:3002/?redirect=${redirectUrl}`;
            
            log(`è·³è½¬åˆ°ç™»å½•é¡µé¢: ${loginUrl}`);
            window.open(loginUrl, '_blank');
        }

        async function proxyAccess() {
            log('å°è¯•ä»£ç†è®¿é—®åˆ†äº«é“¾æ¥...');
            
            // é¦–å…ˆæ£€æŸ¥è®¤è¯
            const isAuthenticated = await checkAuth();
            
            if (!isAuthenticated) {
                updateStatus('âŒ è¯·å…ˆç™»å½•æ‰èƒ½è®¿é—®åˆ†äº«é“¾æ¥', 'error');
                log('è®¿é—®è¢«æ‹’ç» - ç”¨æˆ·æœªè®¤è¯');
                return;
            }

            // è·å–åˆ†äº«é“¾æ¥
            const shareLink = document.getElementById('shareLink').textContent;
            log(`å‡†å¤‡è®¿é—®: ${shareLink}`);

            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€åˆ†äº«é“¾æ¥
            const newWindow = window.open(shareLink, '_blank');
            
            // æ³¨å…¥è®¤è¯é€»è¾‘åˆ°æ–°çª—å£
            setTimeout(() => {
                try {
                    const userToken = localStorage.getItem('shareUserToken');
                    const userInfo = localStorage.getItem('shareUserInfo');
                    
                    // å°†è®¤è¯ä¿¡æ¯ä¼ é€’ç»™æ–°çª—å£
                    newWindow.localStorage.setItem('shareUserToken', userToken);
                    newWindow.localStorage.setItem('shareUserInfo', userInfo);
                    
                    // æ³¨å…¥èŠå¤©ç›‘æ§è„šæœ¬
                    const script = `
                        // ç›‘æ§èŠå¤©æ¶ˆæ¯
                        const originalFetch = window.fetch;
                        window.fetch = function(...args) {
                            const result = originalFetch.apply(this, args);
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯èŠå¤©APIè°ƒç”¨
                            if (args[0] && args[0].includes('/api/') && args[1] && args[1].method === 'POST') {
                                result.then(response => {
                                    if (response.ok) {
                                        // è®°å½•èŠå¤©åˆ°ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
                                        const userInfo = JSON.parse(localStorage.getItem('shareUserInfo') || '{}');
                                        const chatData = {
                                            userId: userInfo.id,
                                            username: userInfo.username,
                                            shareId: new URLSearchParams(window.location.search).get('shareId'),
                                            message: 'ç”¨æˆ·è¿›è¡Œäº†èŠå¤©äº¤äº’',
                                            timestamp: new Date().toISOString()
                                        };
                                        
                                        fetch('http://localhost:3002/api/chat/log', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': 'Bearer ' + localStorage.getItem('shareUserToken')
                                            },
                                            body: JSON.stringify(chatData)
                                        }).catch(err => console.log('èŠå¤©è®°å½•å¤±è´¥:', err));
                                    }
                                });
                            }
                            
                            return result;
                        };
                        
                        console.log('âœ… FastGPTè®¤è¯ä»£ç†å·²æ¿€æ´» - èŠå¤©å°†è¢«ç›‘æ§');
                    `;
                    
                    newWindow.eval(script);
                    log('âœ… è®¤è¯ä»£ç†å·²æ³¨å…¥åˆ°åˆ†äº«é¡µé¢');
                    updateStatus('âœ… åˆ†äº«é“¾æ¥å·²åœ¨æ–°çª—å£ä¸­æ‰“å¼€ï¼ŒèŠå¤©å°†è¢«ç›‘æ§', 'success');
                    
                } catch (error) {
                    log(`ä»£ç†æ³¨å…¥å¤±è´¥: ${error.message}`, 'error');
                }
            }, 2000);
        }

        function clearData() {
            localStorage.removeItem('shareUserToken');
            localStorage.removeItem('shareUserInfo');
            logs = [];
            document.getElementById('logs').innerHTML = '';
            updateStatus('ğŸ—‘ï¸ æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'warning');
            log('æœ¬åœ°æ•°æ®å·²æ¸…é™¤');
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            log('è®¤è¯ä»£ç†ç³»ç»Ÿå·²å¯åŠ¨');
            checkAuth();
        };

        // ç›‘å¬æ¥è‡ªç™»å½•é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.origin === 'http://localhost:3002') {
                if (event.data.type === 'LOGIN_SUCCESS') {
                    log('æ”¶åˆ°ç™»å½•æˆåŠŸé€šçŸ¥');
                    localStorage.setItem('shareUserToken', event.data.token);
                    localStorage.setItem('shareUserInfo', JSON.stringify(event.data.user));
                    checkAuth();
                }
            }
        });
    </script>
</body>
</html>
